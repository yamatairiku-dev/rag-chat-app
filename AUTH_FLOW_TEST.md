# 認証フロー確認ガイド

**確認日**: 2025年1月  
**目的**: Phase 1の認証フローが正しく動作することを確認

---

## 🔍 確認手順

### 1. 環境変数の確認

```bash
# 環境変数が正しく設定されているか確認
node -e "require('dotenv').config(); console.log('ENTRA_REDIRECT_URI:', process.env.ENTRA_REDIRECT_URI);"
```

**重要**: `ENTRA_REDIRECT_URI` が開発サーバーのポートと一致しているか確認
- 開発サーバー: `http://localhost:5173`
- リダイレクトURI: `http://localhost:5173/auth/callback` である必要があります

### 2. 開発サーバー起動

```bash
npm run dev
```

**期待結果**:
- サーバーが `http://localhost:5173` で起動
- エラーなく起動する

### 3. ブラウザでアクセス

1. **ホーム画面**: `http://localhost:5173`
   - セッションがない場合、`/auth/login` にリダイレクトされる

2. **ログイン画面**: `http://localhost:5173/auth/login`
   - Microsoft Entra IDの認証画面にリダイレクトされる
   - コンソールに `[ログイン] 認証URL生成完了` が表示される

3. **Microsoft認証**
   - Microsoftアカウントでログイン
   - 同意画面で「同意する」をクリック
   - `/auth/callback?code=xxx` にリダイレクトされる

4. **認証コールバック**
   - コンソールに以下のログが表示される:
     ```
     [認証コールバック] リクエスト受信: { code: 'あり', error: null }
     [認証コールバック] ステップ1: トークン取得開始
     [認証コールバック] ステップ1: トークン取得完了
     [認証コールバック] ステップ2: ユーザー情報取得開始
     [認証コールバック] ステップ2: ユーザー情報取得完了
     [認証コールバック] ステップ3: 所属部署取得開始
     [認証コールバック] ステップ3: 所属部署取得完了
     [認証コールバック] ステップ4: セッション作成開始
     [認証コールバック] ステップ4: セッション作成完了
     [認証コールバック] ステップ5: チャット画面へリダイレクト
     ```

5. **チャット画面**: `http://localhost:5173/chat`
   - ユーザー情報が表示される
   - セッションがCookieに保存されている

---

## ⚠️ よくあるエラーと対処法

### エラー1: "AADSTS50011: The reply URL ... does not match"

**原因**: Azure PortalのリダイレクトURIと`.env`の`ENTRA_REDIRECT_URI`が一致しない

**対処法**:
1. Azure PortalでリダイレクトURIを確認
2. `.env`の`ENTRA_REDIRECT_URI`を修正
   ```bash
   ENTRA_REDIRECT_URI=http://localhost:5173/auth/callback
   ```
3. Azure PortalでリダイレクトURIを追加（必要に応じて）

### エラー2: "所属部署が見つかりません"

**原因**: ユーザーが所属部署グループに所属していない、またはグループ名の形式が正しくない

**対処法**:
1. Azure Portalでユーザーがグループに所属しているか確認
2. グループ名が正しい形式か確認（例: `DEPT_001_営業部`）
3. `.env`の`GRAPH_DEPARTMENT_GROUP_PREFIX`が正しいか確認（デフォルト: `DEPT_`）

### エラー3: "トークンの取得に失敗しました"

**原因**: 
- クライアントシークレットが間違っている
- APIパーミッションが設定されていない
- 管理者の同意が付与されていない

**対処法**:
1. Azure Portalでクライアントシークレットを確認
2. `.env`の`ENTRA_CLIENT_SECRET`を更新
3. APIパーミッションを確認
4. 管理者の同意を付与

### エラー4: セッションが保持されない

**原因**: Cookie設定の問題

**対処法**:
1. `.env`のCookie設定を確認
   ```bash
   COOKIE_SECURE=false  # 開発環境ではfalse
   COOKIE_HTTP_ONLY=true
   COOKIE_SAME_SITE=lax
   ```
2. ブラウザのCookie設定を確認
3. 開発者ツールでCookieが設定されているか確認

---

## 📊 確認チェックリスト

### 基本動作
- [ ] 開発サーバーが正常に起動する
- [ ] ホーム画面にアクセスできる
- [ ] ログイン画面にリダイレクトされる（セッションなし）
- [ ] ログイン画面からMicrosoft認証にリダイレクトされる

### 認証フロー
- [ ] Microsoftアカウントでログインできる
- [ ] 認証コードが正常に交換される（コンソールログ確認）
- [ ] ユーザー情報が取得できる（コンソールログ確認）
- [ ] 所属部署情報が取得できる（コンソールログ確認）
- [ ] セッションが作成される（コンソールログ確認）
- [ ] チャット画面にリダイレクトされる

### セッション管理
- [ ] セッションがCookieに保存される（開発者ツールで確認）
- [ ] セッションが正しく取得できる
- [ ] チャット画面でユーザー情報が表示される

### デバッグ情報
- [ ] コンソールに認証フローのログが表示される
- [ ] エラーが発生した場合、適切なエラーメッセージが表示される

---

## 🎯 完了基準

以下の条件をすべて満たした場合、認証フローは正常に動作しています：

- ✅ ログイン画面が表示される
- ✅ Microsoftアカウントでログインできる
- ✅ ユーザー情報が取得できる
- ✅ 所属コードが取得できる
- ✅ セッションが保存される
- ✅ チャット画面にリダイレクトされる
- ✅ チャット画面でユーザー情報が表示される

---

## 📝 確認結果

### 確認日時
- 日時: ___________

### 確認者
- 名前: ___________

### 確認結果
- [ ] すべての項目が正常に動作する
- [ ] 一部の項目で問題がある（詳細を記録）
- [ ] 重大な問題がある（詳細を記録）

### 問題点（あれば）
1. ___________
2. ___________
3. ___________

### 次のステップ
- [ ] Phase 2の実装を開始
- [ ] 問題を修正してからPhase 2に進む

---

**最終更新**: 2025年1月

