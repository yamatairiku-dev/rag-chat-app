# トラブルシューティングガイド

このドキュメントでは、よくある問題とその解決方法を説明します。

---

## 認証関連の問題

### 1. ログインできない

#### 症状
- ログインボタンをクリックしても認証ページにリダイレクトされない
- 認証後にエラーが表示される

#### 確認項目

1. **環境変数の確認**
   ```bash
   # .envファイルを確認
   cat .env | grep ENTRA
   ```

   以下の環境変数が正しく設定されているか確認：
   - `ENTRA_CLIENT_ID`
   - `ENTRA_CLIENT_SECRET`
   - `ENTRA_TENANT_ID`
   - `ENTRA_REDIRECT_URI`

2. **Azure Portal設定の確認**
   - Azure Portalでアプリ登録のリダイレクトURIが正しく設定されているか
   - `ENTRA_REDIRECT_URI`と一致しているか

3. **ブラウザのコンソールエラー確認**
   - 開発者ツール（F12）を開いてエラーを確認
   - ネットワークタブでリクエストのステータスコードを確認

#### 解決方法

```bash
# 環境変数を再設定
export ENTRA_CLIENT_ID="your-client-id"
export ENTRA_CLIENT_SECRET="your-client-secret"
export ENTRA_TENANT_ID="your-tenant-id"
export ENTRA_REDIRECT_URI="http://localhost:3000/auth"

# アプリケーションを再起動
npm run dev
```

---

### 2. セッションがすぐに切れる

#### 症状
- ログイン後、短時間でログアウトされる
- 「セッションが切れました」というメッセージが表示される

#### 確認項目

1. **セッション設定の確認**
   ```bash
   # .envファイルでSESSION_MAX_AGEを確認
   echo $SESSION_MAX_AGE
   ```

2. **セッションストレージの確認**
   - メモリストレージを使用している場合、サーバー再起動でセッションが失われる
   - Redisを使用している場合、Redisサーバーが起動しているか確認

#### 解決方法

```bash
# SESSION_MAX_AGEを延長（デフォルト: 86400000ms = 24時間）
export SESSION_MAX_AGE=172800000  # 48時間

# Redisを使用する場合
export SESSION_STORAGE_TYPE=redis
export REDIS_URL=redis://localhost:6379
```

---

## Dify API関連の問題

### 3. Dify APIに接続できない

#### 症状
- チャットメッセージを送信してもエラーが表示される
- 「Dify APIとの通信に失敗しました」というメッセージが表示される

#### 確認項目

1. **環境変数の確認**
   ```bash
   # Dify API設定を確認
   cat .env | grep DIFY
   ```

   - `DIFY_API_URL`が正しく設定されているか
   - `DIFY_API_KEY`が正しい形式か（`app-`で始まるか）

2. **Dify APIの接続テスト**
   ```bash
   # 接続テストスクリプトを実行
   npx tsx test-dify-api-direct.ts
   ```

3. **ネットワーク接続の確認**
   ```bash
   # Dify API URLにアクセスできるか確認
   curl -I $DIFY_API_URL/chat-messages
   ```

#### 解決方法

```bash
# 環境変数を再設定
export DIFY_API_URL="https://your-dify-instance.com/v1"
export DIFY_API_KEY="app-your-api-key"

# 接続テストを実行
npx tsx test-dify-api-direct.ts
```

**よくあるエラー**:

- `400 BAD REQUEST - Workflow not published`: Difyのワークフローが公開されていない
  - 解決方法: Dify管理画面でワークフローを公開する

- `401 Unauthorized`: APIキーが無効
  - 解決方法: Dify管理画面でAPIキーを再生成する

---

### 4. ストリーミングが途中で止まる

#### 症状
- チャットの応答が途中で止まる
- ストリーミングインジケーター（▋）が消えない

#### 確認項目

1. **ネットワーク接続の確認**
   - ブラウザのネットワークタブでSSE接続が維持されているか
   - タイムアウトが発生していないか

2. **Dify APIのタイムアウト設定**
   ```bash
   # DIFY_TIMEOUTを確認（デフォルト: 30000ms = 30秒）
   echo $DIFY_TIMEOUT
   ```

3. **ブラウザのコンソールエラー確認**
   - エラーメッセージがないか確認

#### 解決方法

```bash
# タイムアウトを延長
export DIFY_TIMEOUT=60000  # 60秒

# アプリケーションを再起動
npm run dev
```

---

## ビルド・デプロイ関連の問題

### 5. ビルドが失敗する

#### 症状
- `npm run build`がエラーで失敗する
- 型エラーが表示される

#### 確認項目

1. **型チェックの実行**
   ```bash
   npm run typecheck
   ```

2. **依存関係の確認**
   ```bash
   npm install
   ```

3. **Node.jsバージョンの確認**
   ```bash
   node --version  # v24以上が必要
   ```

#### 解決方法

```bash
# 依存関係を再インストール
rm -rf node_modules package-lock.json
npm install

# 型チェックを実行
npm run typecheck

# ビルドを再実行
npm run build
```

---

### 6. 本番環境で動作しない

#### 症状
- 開発環境では動作するが、本番環境でエラーが発生する

#### 確認項目

1. **環境変数の確認**
   - 本番環境の環境変数が正しく設定されているか
   - `.env`ファイルが本番環境に存在するか

2. **ビルドの確認**
   ```bash
   # 本番ビルドを実行
   npm run build

   # ビルドファイルが生成されているか確認
   ls -la build/
   ```

3. **ログの確認**
   - サーバーログを確認してエラーメッセージを特定

#### 解決方法

```bash
# 本番環境変数を設定
export NODE_ENV=production
export PORT=3000
# ... その他の環境変数

# ビルドを実行
npm run build

# サーバーを起動
npm start
```

---

## テスト関連の問題

### 7. テストが失敗する

#### 症状
- `npm test`がエラーで失敗する
- 特定のテストが失敗する

#### 確認項目

1. **テスト環境変数の確認**
   ```bash
   # テスト実行時に環境変数が設定されているか確認
   npm test -- --reporter=verbose
   ```

2. **モックの確認**
   - モックが正しく設定されているか
   - 依存関係が正しくモックされているか

#### 解決方法

```bash
# テストを個別に実行してエラーを特定
npm test -- tests/unit/routes/chat-loader.test.ts

# カバレッジレポートを確認
npm run test -- --coverage
```

---

## パフォーマンス関連の問題

### 8. ページの読み込みが遅い

#### 症状
- 初回ロードに時間がかかる
- チャット画面の表示が遅い

#### 確認項目

1. **バンドルサイズの確認**
   ```bash
   npm run build
   # build/client/assets のサイズを確認
   ```

2. **ネットワークタブの確認**
   - ブラウザの開発者ツールでネットワークタブを確認
   - どのリソースの読み込みに時間がかかっているか

#### 解決方法

```bash
# バンドルサイズを分析
npm run build
du -sh build/client/assets/*

# Code Splittingが正しく動作しているか確認
# vite.config.tsで設定を確認
```

---

## ログ・デバッグ

### 9. ログが出力されない

#### 症状
- エラーが発生しているがログに出力されない
- デバッグ情報が表示されない

#### 確認項目

1. **ログレベルの確認**
   ```bash
   # LOG_LEVELを確認（デフォルト: info）
   echo $LOG_LEVEL
   ```

2. **ログファイルの確認**
   - ログがファイルに出力されているか
   - ログファイルのパスを確認

#### 解決方法

```bash
# ログレベルを変更
export LOG_LEVEL=debug  # debug, info, warn, error

# アプリケーションを再起動
npm run dev
```

---

## よくあるエラーメッセージ

### エラーコード一覧

| エラーコード | 説明 | 解決方法 |
|------------|------|----------|
| `1001` | トークン無効 | 再ログインする |
| `1002` | トークン期限切れ | 再ログインする |
| `2001` | Dify接続失敗 | Dify API設定を確認 |
| `2002` | Difyタイムアウト | タイムアウト設定を確認 |
| `2004` | Dify APIエラー | Dify APIの状態を確認 |
| `3001` | メッセージ空 | メッセージを入力する |
| `3002` | メッセージ長すぎ | メッセージを短くする |

---

## サポート

問題が解決しない場合は、以下を確認してください：

1. **ログファイルの確認**
   - エラーログを確認してエラーメッセージを特定

2. **環境情報の収集**
   ```bash
   # 環境情報を収集
   node --version
   npm --version
   cat package.json | grep version
   ```

3. **再現手順の記録**
   - 問題が発生するまでの手順を記録
   - スクリーンショットやエラーメッセージを保存

---

**最終更新**: 2025年12月5日



