# department_codeãŒ"user"ã«ãªã‚‹å•é¡Œã®èª¿æŸ»

**ä½œæˆæ—¥**: 2025å¹´12æœˆ5æ—¥  
**å•é¡Œ**: Difyå´ã§`department_code`ã‚’å–å¾—ã—ãŸã‚‰`"user"`ã¨ã„ã†å€¤ã«ãªã£ã¦ã„ãŸ

---

## ðŸ” å•é¡Œã®åŽŸå› 

### ç¾åœ¨ã®å®Ÿè£…

`app/lib/graph/user-service.ts`ã®`getUserDepartment`é–¢æ•°ã§ã¯ã€ä»¥ä¸‹ã®ãƒ­ã‚¸ãƒƒã‚¯ã§éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¦ã„ã¾ã™ï¼š

```typescript
// "DEPT_001_å–¶æ¥­éƒ¨" â†’ ["DEPT", "001", "å–¶æ¥­éƒ¨"]
const parts = departmentGroup.displayName.split('_');

const result = {
  code: parts[1],  // "001" ã‚’æœŸå¾…
  name: parts.slice(2).join('_'),  // "å–¶æ¥­éƒ¨"
  ...
};
```

### å•é¡Œã®å¯èƒ½æ€§

`department_code`ãŒ`"user"`ã«ãªã‚‹åŽŸå› ã¨ã—ã¦ã€ä»¥ä¸‹ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

#### 1. ã‚°ãƒ«ãƒ¼ãƒ—åã®å½¢å¼ãŒæƒ³å®šã¨ç•°ãªã‚‹

**æƒ³å®šã•ã‚Œã‚‹å½¢å¼**: `DEPT_001_å–¶æ¥­éƒ¨`
- `parts[0]` = `"DEPT"`
- `parts[1]` = `"001"` âœ…
- `parts[2]` = `"å–¶æ¥­éƒ¨"`

**å®Ÿéš›ã®å½¢å¼ï¼ˆæŽ¨æ¸¬ï¼‰**: `DEPT_user_001_å–¶æ¥­éƒ¨` ã¾ãŸã¯ `DEPT_user_xxx`
- `parts[0]` = `"DEPT"`
- `parts[1]` = `"user"` âŒ â† ã“ã‚ŒãŒå–å¾—ã•ã‚Œã¦ã„ã‚‹
- `parts[2]` = `"001"` ã¾ãŸã¯ `"xxx"`

#### 2. ã‚°ãƒ«ãƒ¼ãƒ—åã®å‘½åè¦å‰‡ãŒç•°ãªã‚‹

Entra IDã®ã‚°ãƒ«ãƒ¼ãƒ—åãŒä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ï¼š
- `DEPT_user_001_å–¶æ¥­éƒ¨`
- `DEPT_user_å–¶æ¥­éƒ¨`
- `DEPT_user`

---

## ðŸ”§ ç¢ºèªæ–¹æ³•

### 1. ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã®ç¢ºèª

èªè¨¼æ™‚ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

```
[æ‰€å±žéƒ¨ç½²å–å¾—] Graph APIå¿œç­”: ...
[æ‰€å±žéƒ¨ç½²å–å¾—] ã‚°ãƒ«ãƒ¼ãƒ—ä¸€è¦§:
  [1] ID: xxx, è¡¨ç¤ºå: DEPT_user_001_å–¶æ¥­éƒ¨  â† å®Ÿéš›ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ç¢ºèª
[æ‰€å±žéƒ¨ç½²å–å¾—] è¦‹ã¤ã‹ã£ãŸéƒ¨ç½²ã‚°ãƒ«ãƒ¼ãƒ—: {
  displayName: "DEPT_user_001_å–¶æ¥­éƒ¨"  â† å®Ÿéš›ã®ã‚°ãƒ«ãƒ¼ãƒ—å
}
[æ‰€å±žéƒ¨ç½²å–å¾—] ã‚°ãƒ«ãƒ¼ãƒ—åã‚’åˆ†å‰²: ["DEPT", "user", "001", "å–¶æ¥­éƒ¨"]
[æ‰€å±žéƒ¨ç½²å–å¾—] æŠ½å‡ºçµæžœ: {
  code: "user",  â† å•é¡Œ: parts[1]ãŒ"user"ã«ãªã£ã¦ã„ã‚‹
  name: "001_å–¶æ¥­éƒ¨"
}
```

### 2. Graph APIã®ç›´æŽ¥ç¢ºèª

ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§Graph APIã‹ã‚‰ç›´æŽ¥ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—ã—ã¦ç¢ºèªï¼š

```bash
# Graph APIã§ã‚°ãƒ«ãƒ¼ãƒ—æƒ…å ±ã‚’å–å¾—
curl -H "Authorization: Bearer {access_token}" \
  "https://graph.microsoft.com/v1.0/me/memberOf"
```

---

## ðŸ’¡ è§£æ±ºç­–

### è§£æ±ºç­–1: ã‚°ãƒ«ãƒ¼ãƒ—åã®å‘½åè¦å‰‡ã‚’å¤‰æ›´ï¼ˆæŽ¨å¥¨ï¼‰

Entra IDã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ä»¥ä¸‹ã®å½¢å¼ã«çµ±ä¸€ï¼š

```
DEPT_{éƒ¨ç½²ã‚³ãƒ¼ãƒ‰}_{éƒ¨ç½²å}
ä¾‹: DEPT_001_å–¶æ¥­éƒ¨
```

**æ³¨æ„**: ã‚°ãƒ«ãƒ¼ãƒ—åã«`user`ã‚’å«ã‚ãªã„ã‚ˆã†ã«ã™ã‚‹

### è§£æ±ºç­–2: ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦`user`ã‚’ã‚¹ã‚­ãƒƒãƒ—

ã‚°ãƒ«ãƒ¼ãƒ—åãŒ`DEPT_user_001_å–¶æ¥­éƒ¨`ã®ã‚ˆã†ãªå½¢å¼ã®å ´åˆã€`user`ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦æ¬¡ã®è¦ç´ ã‚’å–å¾—ï¼š

```typescript
// app/lib/graph/user-service.ts
const parts = departmentGroup.displayName.split('_');

// "DEPT_user_001_å–¶æ¥­éƒ¨" â†’ ["DEPT", "user", "001", "å–¶æ¥­éƒ¨"]
// parts[1]ãŒ"user"ã®å ´åˆã¯ã€parts[2]ã‚’éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨
let departmentCodeIndex = 1;
if (parts.length > 2 && parts[1] === 'user') {
  departmentCodeIndex = 2;  // "user"ã‚’ã‚¹ã‚­ãƒƒãƒ—
}

if (parts.length < departmentCodeIndex + 1) {
  console.log("[æ‰€å±žéƒ¨ç½²å–å¾—] ã‚°ãƒ«ãƒ¼ãƒ—åã®å½¢å¼ãŒä¸æ­£ã§ã™");
  return null;
}

const result = {
  code: parts[departmentCodeIndex],  // "001"
  name: parts.slice(departmentCodeIndex + 1).join('_'),  // "å–¶æ¥­éƒ¨"
  groupId: departmentGroup.id,
  groupName: departmentGroup.displayName,
};
```

### è§£æ±ºç­–3: æ­£è¦è¡¨ç¾ã§éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡º

ã‚°ãƒ«ãƒ¼ãƒ—åã‹ã‚‰æ•°å€¤ã®éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã‚’ç›´æŽ¥æŠ½å‡ºï¼š

```typescript
// app/lib/graph/user-service.ts
const parts = departmentGroup.displayName.split('_');

// éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã¯æ•°å€¤ï¼ˆ3æ¡ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
const codeMatch = departmentGroup.displayName.match(/DEPT_(?:user_)?(\d{3})_/);
if (!codeMatch) {
  console.log("[æ‰€å±žéƒ¨ç½²å–å¾—] ã‚°ãƒ«ãƒ¼ãƒ—åã‹ã‚‰éƒ¨ç½²ã‚³ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ");
  return null;
}

const result = {
  code: codeMatch[1],  // æ­£è¦è¡¨ç¾ã§æŠ½å‡ºã—ãŸéƒ¨ç½²ã‚³ãƒ¼ãƒ‰
  name: parts.slice(parts.indexOf(codeMatch[1]) + 1).join('_'),
  groupId: departmentGroup.id,
  groupName: departmentGroup.displayName,
};
```

---

## ðŸ“‹ æŽ¨å¥¨ã•ã‚Œã‚‹å¯¾å¿œæ‰‹é †

1. **ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã‚’ç¢ºèª**
   - èªè¨¼æ™‚ã®ãƒ­ã‚°ã§å®Ÿéš›ã®ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ç¢ºèª
   - `[æ‰€å±žéƒ¨ç½²å–å¾—] è¦‹ã¤ã‹ã£ãŸéƒ¨ç½²ã‚°ãƒ«ãƒ¼ãƒ—`ã®ãƒ­ã‚°ã‚’ç¢ºèª

2. **ã‚°ãƒ«ãƒ¼ãƒ—åã®å½¢å¼ã‚’ç¢ºèª**
   - Entra IDã®ç®¡ç†ç”»é¢ã§ã‚°ãƒ«ãƒ¼ãƒ—åã‚’ç¢ºèª
   - ã‚°ãƒ«ãƒ¼ãƒ—åãŒ`DEPT_user_001_å–¶æ¥­éƒ¨`ã®ã‚ˆã†ãªå½¢å¼ã‹ã©ã†ã‹ç¢ºèª

3. **è§£æ±ºç­–ã‚’é¸æŠž**
   - **ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å¤‰æ›´ã§ãã‚‹å ´åˆ**: è§£æ±ºç­–1ã‚’æŽ¨å¥¨
   - **ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å¤‰æ›´ã§ããªã„å ´åˆ**: è§£æ±ºç­–2ã¾ãŸã¯3ã‚’å®Ÿè£…

4. **ä¿®æ­£å¾Œã®å‹•ä½œç¢ºèª**
   - èªè¨¼å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®`departmentCode`ã‚’ç¢ºèª
   - Dify APIã«é€ä¿¡ã•ã‚Œã‚‹`inputs.department_code`ã‚’ç¢ºèª

---

## ðŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- **å®Ÿè£…**: `app/lib/graph/user-service.ts`
- **èªè¨¼å‡¦ç†**: `app/routes/auth.tsx`
- **Dify APIé€ä¿¡**: `app/routes/api.chat-stream.ts`
- **ç’°å¢ƒå¤‰æ•°**: `app/lib/utils/env.ts` (GRAPH_DEPARTMENT_GROUP_PREFIX)

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´12æœˆ5æ—¥

