# 開発環境動作確認手順

**作成日**: 2025年12月5日  
**目的**: 本番環境へのデプロイ前に、開発環境で全機能の動作確認を行う

---

## 📋 確認項目チェックリスト

### 環境設定
- [ ] 環境変数が正しく設定されている
- [ ] 開発サーバーが正常に起動する
- [ ] ビルドが正常に完了する

### 認証機能
- [ ] ログインページが表示される
- [ ] Entra ID認証が正常に動作する
- [ ] リダイレクトが正常に動作する
- [ ] ログアウトが正常に動作する
- [ ] セッション管理が正常に動作する

### チャット機能
- [ ] チャットページが表示される
- [ ] メッセージ送信が正常に動作する
- [ ] ストリーミング応答が正常に受信される
- [ ] 会話履歴が正しく表示される
- [ ] エラーハンドリングが正常に動作する
- [ ] リトライ機能が正常に動作する

### UI/UX
- [ ] レスポンシブデザインが正常に動作する
- [ ] アクセシビリティが適切に実装されている
- [ ] エラーメッセージが適切に表示される

### パフォーマンス
- [ ] 初回ロード時間が許容範囲内
- [ ] APIレスポンスタイムが許容範囲内
- [ ] メモリリークがない

### ログ・監視
- [ ] ログが正しく記録されている
- [ ] エラーログが適切に記録されている

---

## 🚀 ステップ1: 環境変数の確認

### 1.1 環境変数ファイルの確認

```bash
# .envファイルが存在するか確認
ls -la .env

# 環境変数の確認（機密情報は表示されません）
cat .env | grep -E "^[A-Z_]+" | sed 's/=.*/=***/'
```

### 1.2 必須環境変数の確認

以下の環境変数が設定されていることを確認してください：

```bash
# 必須環境変数の確認スクリプトを実行
npx tsx scripts/check-production-env.ts
```

**必須項目**:
- `NODE_ENV=development`
- `PORT=3000` (または任意のポート)
- `ENTRA_CLIENT_ID`
- `ENTRA_CLIENT_SECRET`
- `ENTRA_TENANT_ID`
- `ENTRA_REDIRECT_URI` (開発環境: `http://localhost:3000/auth`)
- `DIFY_API_URL`
- `DIFY_API_KEY`
- `SESSION_SECRET` (32文字以上)

### 1.3 セッションシークレットの生成（未設定の場合）

```bash
# セッションシークレットを生成
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# 生成された値を.envファイルのSESSION_SECRETに設定
```

---

## 🚀 ステップ2: 依存関係のインストール

```bash
# 依存関係のインストール
npm install

# インストールの確認
npm list --depth=0
```

---

## 🚀 ステップ3: ビルドの確認

```bash
# 型チェック
npm run typecheck

# ビルドの実行
npm run build

# ビルド結果の確認
ls -la build/
```

**期待される結果**:
- `build/client/` ディレクトリが存在する
- `build/server/` ディレクトリが存在する
- エラーが発生しない

---

## 🚀 ステップ4: 開発サーバーの起動

```bash
# 開発サーバーの起動
npm run dev
```

**確認項目**:
- サーバーが正常に起動する
- コンソールにエラーが表示されない
- アクセスURLが表示される（例: `http://localhost:3000`）

---

## 🚀 ステップ5: ブラウザでの動作確認

### 5.1 基本動作確認

1. **ブラウザでアクセス**
   - URL: `http://localhost:3000`
   - ログインページが表示されることを確認

2. **コンソールエラーの確認**
   - ブラウザの開発者ツール（F12）を開く
   - Consoleタブでエラーがないことを確認
   - Networkタブでリクエストが正常に送信されていることを確認

### 5.2 認証機能の確認

1. **ログイン**
   - 「ログイン」ボタンをクリック
   - Entra IDのログインページにリダイレクトされることを確認
   - ログイン後、チャットページにリダイレクトされることを確認

2. **ユーザー情報の表示**
   - ヘッダーにユーザー名が表示されることを確認
   - ユーザー情報が正しく表示されることを確認

3. **ログアウト**
   - 「ログアウト」ボタンをクリック
   - ログインページにリダイレクトされることを確認

### 5.3 チャット機能の確認

1. **メッセージ送信**
   - チャット入力欄にメッセージを入力
   - 「送信」ボタンをクリック
   - メッセージが表示されることを確認

2. **ストリーミング応答**
   - アシスタントの応答がストリーミング形式で表示されることを確認
   - 応答が段階的に表示されることを確認
   - ストリーミング中のインジケーター（▋）が表示されることを確認

3. **会話履歴**
   - 複数のメッセージを送信
   - 会話履歴が正しく保持されることを確認
   - ページをリロードしても会話履歴が保持されることを確認

4. **エラーハンドリング**
   - ネットワークエラーをシミュレート（開発者ツールでネットワークを無効化）
   - エラーメッセージが適切に表示されることを確認
   - リトライボタンが表示されることを確認

5. **リトライ機能**
   - エラーが発生したメッセージの「再試行」ボタンをクリック
   - メッセージが再送信されることを確認

### 5.4 UI/UXの確認

1. **レスポンシブデザイン**
   - ブラウザのウィンドウサイズを変更
   - モバイル、タブレット、デスクトップの各サイズで表示が適切であることを確認

2. **アクセシビリティ**
   - キーボード操作で全機能が使用できることを確認
   - スクリーンリーダーで読み上げられることを確認（可能な場合）

3. **エラーメッセージ**
   - エラーメッセージが適切に表示されることを確認
   - エラーメッセージが日本語で表示されることを確認

---

## 🚀 ステップ6: APIエンドポイントの確認

### 6.1 ヘルスチェック（実装されている場合）

```bash
# ヘルスチェックエンドポイント
curl http://localhost:3000/api/health
```

### 6.2 認証エンドポイント

```bash
# 認証エンドポイント（ブラウザで確認）
# http://localhost:3000/auth/login
```

### 6.3 チャットストリーミングエンドポイント

```bash
# チャットストリーミングエンドポイント（ブラウザで確認）
# POST http://localhost:3000/api/chat-stream
```

---

## 🚀 ステップ7: ログの確認

### 7.1 サーバーログの確認

開発サーバーのコンソールで以下を確認：

- [ ] エラーログが記録されている
- [ ] アクセスログが記録されている
- [ ] 警告ログが記録されている

### 7.2 ログファイルの確認（実装されている場合）

```bash
# ログディレクトリの確認
ls -la logs/

# 最新のログファイルを確認
tail -f logs/app.log
```

---

## 🚀 ステップ8: パフォーマンスの確認

### 8.1 初回ロード時間

1. ブラウザの開発者ツールを開く
2. Networkタブを開く
3. ページをリロード（Ctrl+R / Cmd+R）
4. 初回ロード時間を確認（目標: 3秒以内）

### 8.2 APIレスポンスタイム

1. NetworkタブでAPIリクエストを確認
2. レスポンスタイムを確認（目標: 2秒以内）

### 8.3 メモリ使用量

1. Performanceタブを開く
2. メモリプロファイルを記録
3. メモリリークがないことを確認

---

## 🚀 ステップ9: テストの実行

### 9.1 ユニットテスト

```bash
# ユニットテストの実行
npm test

# カバレッジレポートの生成
npm run test -- --coverage
```

**期待される結果**:
- すべてのテストが成功する
- カバレッジが76%以上

### 9.2 E2Eテスト

```bash
# E2Eテストの実行
npm run test:e2e
```

**期待される結果**:
- すべてのE2Eテストが成功する

---

## 🚀 ステップ10: エラーシナリオの確認

### 10.1 ネットワークエラー

1. ブラウザの開発者ツールでネットワークを無効化
2. メッセージを送信
3. エラーメッセージが適切に表示されることを確認

### 10.2 Dify APIエラー

1. Dify APIのURLを無効な値に変更
2. メッセージを送信
3. エラーメッセージが適切に表示されることを確認
4. リトライ機能が動作することを確認

### 10.3 認証エラー

1. セッションを無効化（Cookieを削除）
2. ページにアクセス
3. ログインページにリダイレクトされることを確認

---

## 📊 確認結果の記録

以下のテンプレートを使用して確認結果を記録してください：

```markdown
## 動作確認結果

**確認日**: YYYY-MM-DD
**確認者**: [名前]
**環境**: 開発環境

### 環境設定
- [ ] 環境変数: ✅ / ❌
- [ ] ビルド: ✅ / ❌
- [ ] サーバー起動: ✅ / ❌

### 認証機能
- [ ] ログイン: ✅ / ❌
- [ ] ログアウト: ✅ / ❌
- [ ] セッション管理: ✅ / ❌

### チャット機能
- [ ] メッセージ送信: ✅ / ❌
- [ ] ストリーミング応答: ✅ / ❌
- [ ] エラーハンドリング: ✅ / ❌
- [ ] リトライ機能: ✅ / ❌

### パフォーマンス
- [ ] 初回ロード時間: [秒]
- [ ] APIレスポンスタイム: [秒]

### 問題点
1. [問題の説明]
2. [問題の説明]

### 次のアクション
1. [アクション項目]
2. [アクション項目]
```

---

## 🔍 トラブルシューティング

### 問題: サーバーが起動しない

**確認項目**:
1. ポートが使用されていないか確認
   ```bash
   lsof -i :3000
   ```
2. 環境変数が正しく設定されているか確認
3. 依存関係がインストールされているか確認

### 問題: 認証が動作しない

**確認項目**:
1. `ENTRA_REDIRECT_URI`が正しく設定されているか確認
2. Azure PortalでリダイレクトURIが登録されているか確認
3. `ENTRA_CLIENT_ID`と`ENTRA_CLIENT_SECRET`が正しいか確認

### 問題: Dify API接続エラー

**確認項目**:
1. `DIFY_API_URL`が正しいか確認
2. `DIFY_API_KEY`が`app-`で始まっているか確認
3. Dify VMが起動しているか確認
4. ネットワーク接続が確立されているか確認

### 問題: ストリーミングが動作しない

**確認項目**:
1. ブラウザのコンソールでエラーがないか確認
2. Networkタブでストリーミングリクエストが送信されているか確認
3. Dify APIがストリーミングをサポートしているか確認

---

## 📝 関連ドキュメント

- [環境変数設定](./02_環境変数設定.md)
- [トラブルシューティング](./13_トラブルシューティング.md)
- [デプロイ手順書](./15_デプロイ手順書.md)

---

**最終更新**: 2025年12月5日

