# Entra ID 所属部署設定ガイド

## 概要

このアプリケーションでは、所属部署情報を取得するために**グループベース**の方法を使用しています。

## 現在の実装方法（グループベース）

### 設定場所

所属部署情報は、**Entra ID（Azure AD）のグループ**に設定します。

### 手順

#### 1. Azure Portalでグループを作成

1. **Azure Portal**にログイン
2. **Azure Active Directory**（または**Microsoft Entra ID**）に移動
3. **グループ** → **新しいグループ**をクリック

#### 2. グループ情報を設定

- **グループの種類**: `セキュリティ`
- **グループ名**: `{PREFIX}_{CODE}_{NAME}` の形式で設定
  - 例: `DEPT_001_営業部`
  - 例: `DEPT_002_技術部`
  - 例: `DEPT_003_管理部`
- **グループの説明**: 任意（例: `営業部の従業員`）

#### 3. ユーザーをグループに追加

1. 作成したグループを開く
2. **メンバー**タブを選択
3. **メンバーの追加**をクリック
4. 所属部署に応じたユーザーを選択して追加

### グループ名の命名規則

**形式**: `{PREFIX}_{CODE}_{NAME}`

- **PREFIX**: デフォルトは `DEPT_`（環境変数 `GRAPH_DEPARTMENT_GROUP_PREFIX` で変更可能）
- **CODE**: 所属コード（例: `001`, `002`）
- **NAME**: 部署名（例: `営業部`, `技術部`）

**例**:
- `DEPT_001_営業部` → 所属コード: `001`, 部署名: `営業部`
- `DEPT_002_技術部` → 所属コード: `002`, 部署名: `技術部`

### 確認方法

1. **Azure Portal**でユーザーを開く
2. **グループ**タブを確認
3. `DEPT_` で始まるグループに所属しているか確認

または、以下のコマンドで確認できます：

```bash
# Graph APIテストスクリプトを実行
npm run test:graph
```

## トラブルシューティング

### 問題: 所属部署の取得に失敗する

#### 原因1: ユーザーがグループに所属していない

**解決方法**:
1. Azure Portalでユーザーを開く
2. **グループ**タブを確認
3. `DEPT_` で始まるグループに所属していない場合は、グループに追加

#### 原因2: グループ名の形式が正しくない

**解決方法**:
1. グループ名が `{PREFIX}_{CODE}_{NAME}` の形式になっているか確認
2. 例: `DEPT_001_営業部`（正しい） vs `営業部`（間違い）

#### 原因3: 環境変数の設定が間違っている

**解決方法**:
1. `.env`ファイルの `GRAPH_DEPARTMENT_GROUP_PREFIX` を確認
2. デフォルトは `DEPT_`
3. グループ名のプレフィックスと一致しているか確認

#### 原因4: グループの種類が間違っている

**解決方法**:
1. グループの種類が `セキュリティ` になっているか確認
2. `Microsoft 365` グループでも動作する場合がありますが、`セキュリティ` グループを推奨

## 代替方法: ユーザー属性ベース（将来の拡張）

現在の実装ではグループベースを使用していますが、Entra IDのユーザーオブジェクトには `department` という標準属性もあります。

### ユーザー属性での設定方法

1. **Azure Portal**でユーザーを開く
2. **プロパティ**タブを選択
3. **部署**フィールドに部署名を入力（例: `営業部`）

### 注意点

- 現在の実装では、ユーザー属性の `department` は使用していません
- ユーザー属性ベースに変更する場合は、`app/lib/graph/user-service.ts` の `getUserDepartment` 関数を修正する必要があります
- ユーザー属性ベースの場合、所属コード（`001`, `002`など）を別途管理する必要があります

## 推奨設定

### グループベース（現在の実装）を推奨する理由

1. **所属コードの管理が容易**: グループ名に所属コードを含めることができる
2. **複数の部署への所属に対応**: ユーザーが複数のグループに所属できる（最初に見つかったものを使用）
3. **権限管理との統合**: グループベースのアクセス制御と統合しやすい
4. **柔軟性**: 部署の変更が容易（グループの追加・削除で対応）

### ユーザー属性ベースの利点

1. **シンプル**: ユーザー情報に直接設定できる
2. **標準属性**: Entra IDの標準属性を使用
3. **管理が簡単**: ユーザーごとに個別に設定可能

## まとめ

**現在の実装では、Entra IDのグループに所属部署を設定してください。**

1. グループ名を `DEPT_001_営業部` のような形式で作成
2. ユーザーをそのグループに追加
3. 環境変数 `GRAPH_DEPARTMENT_GROUP_PREFIX` が `DEPT_` に設定されていることを確認

これで所属部署情報が正しく取得できるようになります。

