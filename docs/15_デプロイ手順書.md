# デプロイ手順書

**作成日**: 2025年12月5日  
**対象環境**: Azure App Service（本番環境）

---

## 📋 デプロイ前チェックリスト

### 環境設定

- [ ] 本番環境の環境変数が設定されている
- [ ] セッションシークレットが本番用に生成されている（32文字以上）
- [ ] Dify APIのURLが本番環境のものになっている
- [ ] Entra IDのリダイレクトURIが本番環境のURLになっている

### セキュリティ

- [ ] HTTPS通信が有効
- [ ] `COOKIE_SECURE=true` が設定されている
- [ ] API Keyが環境変数で管理されている（コードにハードコードされていない）
- [ ] セッションタイムアウトが適切（`SESSION_MAX_AGE`）
- [ ] `SESSION_SECRET`が強力な値（32文字以上のランダム文字列）

### パフォーマンス

- [ ] ビルドサイズが適切（最大バンドル: ~800KB以下）
- [ ] ページロード時間が許容範囲（3秒以内）
- [ ] APIレスポンスタイムが許容範囲（2秒以内）

### 監視・ログ

- [ ] エラーログが記録されている
- [ ] アクセスログが記録されている
- [ ] ログローテーションが設定されている（`LOG_MAX_FILES=30`）

### テスト

- [ ] すべてのユニットテストが成功（`npm test`）
- [ ] すべてのE2Eテストが成功（`npm run test:e2e`）
- [ ] テストカバレッジが80%以上
- [ ] 本番ビルドが正常に完了（`npm run build`）

---

## 🔧 環境変数の設定

### 1. セッションシークレットの生成

```bash
# Node.jsで生成（推奨）
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# またはOpenSSLで生成
openssl rand -hex 32
```

生成された値を`SESSION_SECRET`に設定してください。

### 2. 本番環境変数の確認

以下の環境変数がすべて設定されていることを確認してください：

```bash
# Azure App Service設定
NODE_ENV=production
PORT=8080

# Microsoft Entra ID
ENTRA_CLIENT_ID=<UUID形式>
ENTRA_CLIENT_SECRET=<シークレット>
ENTRA_TENANT_ID=<UUID形式>
ENTRA_REDIRECT_URI=https://your-app.azurewebsites.net/auth
ENTRA_POST_LOGOUT_REDIRECT_URI=https://your-app.azurewebsites.net
ENTRA_AUTHORITY=https://login.microsoftonline.com

# Microsoft Graph API
GRAPH_API_URL=https://graph.microsoft.com/v1.0
GRAPH_API_SCOPE=https://graph.microsoft.com/.default
GRAPH_DEPARTMENT_GROUP_PREFIX=^ZA[A-Za-z]\d{3}-[A-Za-z]

# Dify API
DIFY_API_URL=https://your-dify-vm.japaneast.cloudapp.azure.com/v1
DIFY_API_KEY=app-<32文字のAPIキー>
DIFY_TIMEOUT=30000
DIFY_MAX_RETRIES=3

# セッション管理
SESSION_SECRET=<32文字以上のランダム文字列>
SESSION_MAX_AGE=86400000  # 24時間
SESSION_RESET_HOUR=0
SESSION_STORAGE=memory

# Cookie設定
COOKIE_DOMAIN=.your-domain.com  # オプション
COOKIE_SECURE=true  # 本番環境では必須
COOKIE_SAME_SITE=lax
COOKIE_HTTP_ONLY=true

# ログ設定
LOG_LEVEL=info
LOG_DIRECTORY=./logs
LOG_MAX_FILES=30

# パフォーマンス設定
MAX_MESSAGE_LENGTH=2000
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX_REQUESTS=30
```

### 3. Azure App Serviceでの環境変数設定

1. Azure Portalにログイン
2. App Serviceリソースを選択
3. 「設定」→「構成」→「アプリケーション設定」を開く
4. 上記の環境変数をすべて追加
5. 「保存」をクリック

---

## 🚀 デプロイ手順

### 方法1: GitHub Actionsを使用（推奨）

1. **GitHub Secretsの設定**
   - リポジトリの「Settings」→「Secrets and variables」→「Actions」
   - 必要な環境変数をすべて追加

2. **ワークフローの確認**
   - `.github/workflows/deploy.yml`が存在することを確認
   - 必要に応じて設定を調整

3. **デプロイの実行**
   - `main`ブランチにプッシュすると自動デプロイ
   - または、Actionsタブから手動実行

### 方法2: Azure CLIを使用

```bash
# Azure CLIにログイン
az login

# ビルドの実行
npm run build

# デプロイの実行
az webapp deploy \
  --resource-group <リソースグループ名> \
  --name <App Service名> \
  --src-path ./build \
  --type static
```

### 方法3: VS Code拡張機能を使用

1. Azure App Service拡張機能をインストール
2. Azureにログイン
3. App Serviceを右クリック→「Deploy to Web App」
4. ビルドフォルダ（`./build`）を選択

---

## ✅ デプロイ後の確認

### 1. アプリケーションの起動確認

```bash
# ヘルスチェックエンドポイント（実装されている場合）
curl https://your-app.azurewebsites.net/api/health

# またはブラウザでアクセス
https://your-app.azurewebsites.net
```

### 2. 認証の確認

- [ ] ログインページが表示される
- [ ] Entra ID認証が正常に動作する
- [ ] リダイレクトが正常に動作する
- [ ] ログアウトが正常に動作する

### 3. チャット機能の確認

- [ ] チャットページが表示される
- [ ] メッセージ送信が正常に動作する
- [ ] ストリーミング応答が正常に受信される
- [ ] エラーハンドリングが正常に動作する

### 4. ログの確認

```bash
# Azure Portalでログストリームを確認
# 「監視」→「ログストリーム」を開く

# またはAzure CLIで確認
az webapp log tail \
  --resource-group <リソースグループ名> \
  --name <App Service名>
```

### 5. パフォーマンスの確認

- [ ] 初回ロード時間が3秒以内
- [ ] APIレスポンスタイムが2秒以内
- [ ] メモリ使用量が適切な範囲内

---

## 🔍 トラブルシューティング

### デプロイが失敗する

**確認項目**:
1. ビルドが正常に完了するか確認
   ```bash
   npm run build
   ```
2. 環境変数が正しく設定されているか確認
3. Node.jsバージョンが24以上か確認

**解決方法**:
- Azure Portalの「デプロイ センター」でログを確認
- エラーメッセージに基づいて修正

### アプリケーションが起動しない

**確認項目**:
1. 環境変数がすべて設定されているか
2. `SESSION_SECRET`が32文字以上か
3. `COOKIE_SECURE`が`true`に設定されているか（HTTPS環境の場合）

**解決方法**:
- Azure Portalの「ログストリーム」でエラーログを確認
- 環境変数を再確認して修正

### 認証が動作しない

**確認項目**:
1. `ENTRA_REDIRECT_URI`が本番環境のURLになっているか
2. Azure PortalでリダイレクトURIが登録されているか
3. `ENTRA_CLIENT_ID`と`ENTRA_CLIENT_SECRET`が正しいか

**解決方法**:
- Azure Portalの「アプリの登録」でリダイレクトURIを確認
- 環境変数を再設定

### Dify API接続エラー

**確認項目**:
1. `DIFY_API_URL`が正しいか
2. `DIFY_API_KEY`が`app-`で始まっているか
3. Dify VMが起動しているか
4. ネットワーク接続が確立されているか

**解決方法**:
- Dify VMの状態を確認
- ネットワーク設定を確認
- API Keyを再生成

---

## 📊 監視とメンテナンス

### ログの確認

```bash
# Azure Portalでログを確認
# 「監視」→「ログストリーム」または「ログ」を開く

# エラーログの検索
# ログクエリ: `where severityLevel >= 3`
```

### パフォーマンス監視

- Azure Portalの「メトリック」で以下を監視：
  - CPU使用率
  - メモリ使用率
  - レスポンス時間
  - HTTPエラー率

### 定期的なメンテナンス

- [ ] 週次: ログの確認とエラーの確認
- [ ] 月次: 依存関係の更新確認
- [ ] 四半期: セキュリティパッチの適用

---

## 🔐 セキュリティベストプラクティス

### 環境変数の保護

- ✅ `.env`ファイルを`.gitignore`に追加
- ✅ 環境変数をコードにハードコードしない
- ✅ Azure App Serviceの「構成」で管理
- ✅ GitHub SecretsでCI/CD用に管理

### Cookie設定

- ✅ `COOKIE_SECURE=true`（HTTPS環境）
- ✅ `COOKIE_HTTP_ONLY=true`
- ✅ `COOKIE_SAME_SITE=lax`（CSRF対策）

### セッション管理

- ✅ `SESSION_SECRET`を32文字以上の強力な値に設定
- ✅ `SESSION_MAX_AGE`を適切な値に設定（24時間推奨）
- ✅ 定期的なセッションクリーンアップ

---

## 📝 関連ドキュメント

- [環境変数設定](./02_環境変数設定.md)
- [トラブルシューティング](./13_トラブルシューティング.md)
- [チェックリスト](./12_チェックリスト.md)

---

**最終更新**: 2025年12月5日



