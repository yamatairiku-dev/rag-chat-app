# 実装チェックリスト

このドキュメントでは、各Phaseの実装確認項目と注意事項をまとめています。

---

## Phase 1: 認証基盤

### Azure Portal設定
- [ ] Entra IDアプリ登録が完了している
- [ ] クライアントID、テナントID、シークレットを取得済み
- [ ] リダイレクトURIが正しく設定されている
- [ ] APIパーミッション (User.Read, GroupMember.Read.All) が付与されている
- [ ] 管理者の同意が付与されている

### 環境変数設定
- [ ] `.env`ファイルが作成されている
- [ ] 必須環境変数がすべて設定されている
- [ ] セッションシークレットが32文字以上
- [ ] 環境変数バリデーションが通る

### Entra IDグループ設定
- [ ] グループ命名規則 (`DEPT_XXX_部署名`) に従っている
- [ ] テストユーザーがグループに所属している
- [ ] 所属コード抽出ロジックが正しく動作する

### 認証機能
- [ ] ログイン画面が表示される
- [ ] Microsoftアカウントでログインできる
- [ ] ログイン後にチャット画面にリダイレクトされる
- [ ] ユーザー情報が正しく取得できる
- [ ] 所属コードが正しく取得できる
- [ ] 所属コード未設定時にエラーが表示される
- [ ] ログアウトが正常に動作する

### セッション管理
- [ ] セッションが正しく保存される
- [ ] セッションが正しく取得される
- [ ] セッションIDが署名されている
- [ ] Secure Cookieが設定されている
- [ ] セッションタイムアウトが動作する

---

## Phase 2: チャット基本機能

### Dify API設定
- [ ] Dify APIのURLとAPI Keyが設定されている
- [ ] Dify APIに接続できる
- [ ] API Keyが正しい形式 (`app-`で始まる)

### チャット機能
- [ ] チャット画面が表示される
- [ ] メッセージ入力フォームが動作する
- [ ] メッセージが送信できる
- [ ] Dify APIから回答が返ってくる
- [ ] ユーザーIDと所属コードが正しく送信される
- [ ] 会話IDが保持される

### ストリーミング機能
- [ ] ストリーミングレスポンスが動作する
- [ ] リアルタイムに回答が表示される
- [ ] ストリーミング完了が正しく検知される
- [ ] ストリーミングエラーが適切に処理される

### バリデーション
- [ ] 空メッセージは送信できない
- [ ] 最大文字数制限が動作する
- [ ] エラーメッセージが適切に表示される

---

## Phase 3: UI/UX改善

### shadcn/uiセットアップ
- [ ] shadcn/ui CLIでコンポーネントが追加されている
- [ ] Tailwind CSSが正しく設定されている
- [ ] コンポーネントが正しく表示される

### レイアウト
- [ ] ヘッダーが表示される
- [ ] ユーザー情報が表示される
- [ ] ログアウトボタンが動作する
- [ ] サイドバーが表示される (デスクトップ)
- [ ] レスポンシブデザインが動作する

### チャットUI
- [ ] メッセージが見やすく表示される
- [ ] ユーザーとAIのメッセージが区別できる
- [ ] Markdownが正しくレンダリングされる
- [ ] コードブロックがハイライトされる
- [ ] ローディング状態が表示される
- [ ] スクロールが適切に動作する

### アクセシビリティ
- [ ] キーボード操作が可能
- [ ] フォーカス表示が適切
- [ ] スクリーンリーダー対応 (aria-label等)

---

## Phase 4: 機能拡張

### チャット履歴
- [ ] 過去の会話一覧が表示される
- [ ] 会話を選択して再開できる
- [ ] 会話を削除できる
- [ ] ページネーションが動作する

### 設定画面
- [ ] 設定画面が表示される
- [ ] ユーザー情報が表示される
- [ ] 設定変更が保存される

### テスト
- [ ] ユニットテストが通る
- [ ] E2Eテストが通る
- [ ] カバレッジが適切

---

## 開発時の注意事項

### 1. 依存関係を守る
- **重要**: 前のPhaseが完了してから次のPhaseに進む
- 基盤となるファイル (env.ts, 型定義) を先に実装する
- 各ファイルの依存関係を確認してから実装する

### 2. 段階的にテストする
- **重要**: 各ファイルを実装したら動作確認
- Phaseごとに完了基準を満たすか確認
- 問題が発生したら早期に修正

### 3. エラーハンドリングを忘れない
- **重要**: すべての非同期処理でtry-catchを使用
- ユーザーにわかりやすいエラーメッセージを表示
- エラーログを適切に記録

### 4. 型安全性を保つ
- **重要**: any型を使わない
- loaderData/actionDataの型を明示
- 型ガードを活用する

### 5. コミットを細かく
- 1つの機能が動いたらコミット
- コミットメッセージは具体的に
  - 良い例: `feat: Entra ID認証機能を追加`
  - 悪い例: `update`

### 6. セキュリティを意識する
- **重要**: API Keyは環境変数で管理
- トークンはサーバーサイドのみで保持
- ユーザー入力は必ずバリデーション
- XSS, CSRF対策を実装

---

## トラブルシューティング

### ビルドエラー
```bash
# キャッシュクリア
rm -rf node_modules .cache
npm install

# TypeScriptエラー確認
npm run typecheck
```

### 認証エラー
1. Azureポータルでリダイレクト URIを確認
2. 環境変数が正しいか確認
3. APIパーミッションと同意を確認

### Dify API接続エラー
1. Dify VMが起動しているか確認
2. API KeyとURLが正しいか確認
3. ネットワーク接続を確認

### セッションエラー
1. セッションシークレットが設定されているか確認
2. Cookieが正しく設定されているか確認
3. ブラウザのCookieをクリア

---

## デプロイ前チェックリスト

### 環境設定
- [ ] 本番環境の環境変数が設定されている
- [ ] セッションシークレットが本番用に生成されている
- [ ] Dify APIのURLが本番環境のものになっている

### セキュリティ
- [ ] HTTPS通信が有効
- [ ] Secure Cookieが有効
- [ ] API Keyが環境変数で管理されている
- [ ] セッションタイムアウトが適切

### パフォーマンス
- [ ] ビルドサイズが適切
- [ ] ページロード時間が許容範囲
- [ ] APIレスポンスタイムが許容範囲

### 監視・ログ
- [ ] エラーログが記録されている
- [ ] アクセスログが記録されている
- [ ] ログローテーションが設定されている

---

## よくある質問

### Q1: セッションが切れやすい

**A**: セッションタイムアウトを確認してください
```bash
# .env
SESSION_MAX_AGE=86400000  # 24時間
```

### Q2: 所属コードが取得できない

**A**: グループ名が正しい形式か確認してください
- 形式: `DEPT_001_営業部`
- プレフィックス: `DEPT_` (環境変数で設定)

### Q3: Dify APIがタイムアウトする

**A**: タイムアウト値を調整してください
```bash
# .env
DIFY_TIMEOUT=60000  # 60秒
```

### Q4: トークンが自動更新されない

**A**: リフレッシュトークンが保存されているか確認してください

---

## Phase別所要時間の目安

| Phase | 内容 | 初級 | 中級 | 上級 |
|-------|------|------|------|------|
| Phase 1 | 認証基盤 | 12-16h | 8-12h | 6-8h |
| Phase 2 | チャット機能 | 8-10h | 6-8h | 4-6h |
| Phase 3 | UI/UX改善 | 6-8h | 4-6h | 3-4h |
| Phase 4 | 機能拡張 | 12-16h | 8-12h | 6-8h |
| **合計** | | **38-50h** | **26-38h** | **19-26h** |

---

**関連ドキュメント:**
- [README](./README.md)
- [実装ガイド Phase 1-4](./08_実装ガイド_Phase1.md)

**最終更新**: 2025年11月
