# 技術スタック

## フロントエンド

### Runtime & Framework
- **Runtime**: Node.js 24 LTS
  - 理由: 2028年4月までのLTSサポート、最新V8エンジン
  - バージョン: 24.x
  
- **Framework**: React 19 + React Router v7
  - 理由: 
    - Actions API による簡潔なフォーム処理
    - Document Metadata のビルトインサポート
    - 改善されたSuspenseとエラーハンドリング
  - バージョン: React 19.x, React Router 7.x

### 言語・スタイリング
- **Language**: TypeScript 5.x
  - 理由: 型安全性、開発者体験の向上
  - 設定: strict モード有効

- **Styling**: Tailwind CSS
  - 理由: ユーティリティファーストで高速開発
  - バージョン: 3.x

- **UI Components**: shadcn/ui
  - 理由: 
    - コンポーネントのコピー&カスタマイズ可能
    - Tailwind CSSとの統合が良好
    - Radix UIベースでアクセシビリティ対応

### 状態管理
- **Primary**: React Context API
  - 理由: シンプルな状態管理で十分
  - 用途: ユーザーセッション、グローバル設定

- **Optional**: Zustand
  - 理由: 複雑な状態管理が必要な場合の選択肢
  - 検討タイミング: チャット履歴、複数会話の管理が複雑化した時

### HTTP Client
- **Fetch API**
  - 理由: ブラウザ標準、追加ライブラリ不要
  - 使用場所: React Router loader/action内

---

## 認証

### Identity Provider
- **Microsoft Entra ID** (旧 Azure AD)
  - 理由: 社内システムとの統合、既存のアカウント活用
  - 認証フロー: OAuth 2.0 / OpenID Connect

### 組織情報取得
- **Microsoft Graph API**
  - 理由: Entra IDと統合、ユーザー情報・グループ情報の取得
  - スコープ: User.Read, GroupMember.Read.All

---

## バックエンド連携

### RAG Engine
- **Dify（Azure VM版）**
  - 理由: 
    - 社内でのプライベート運用
    - ナレッジベース管理が容易
    - ストリーミングレスポンス対応
  - インフラ: Azure VM上でDocker運用
  - 設定・運用: 情報システム部が担当

### API通信
- **Server-Sent Events (SSE) / ストリーミング**
  - 理由: リアルタイムな回答表示
  - プロトコル: text/event-stream

### API認証
- **API Key**
  - 管理: サーバーサイドの環境変数
  - セキュリティ: クライアントに公開しない

---

## デプロイ・インフラ

### ホスティング
- **Azure App Service**
  - 理由: 
    - Azureエコシステムとの統合
    - スケーリングが容易
    - マネージドサービスで運用負荷が低い

### コンテナ化
- **Docker**
  - 理由: 環境の再現性、デプロイの一貫性
  - ベースイメージ: node:24-alpine

### CI/CD
- **GitHub Actions**
  - 理由: GitHubとの統合、無料枠で十分
  - パイプライン:
    - Lint & Test
    - Build Docker Image
    - Deploy to Azure App Service

### リポジトリ
- **GitHub**
  - 理由: バージョン管理、CI/CD統合

### Dify Infrastructure
- **Azure VM**
  - OS: Ubuntu 22.04 LTS
  - Docker Engine: 最新安定版
  - セキュリティ: NSG（Network Security Group）で制限

---

## 開発ツール

### パッケージマネージャー
- **npm**
  - 理由: Node.js標準、npm 11の改善を活用
  - バージョン: 11.x

### コード品質
- **ESLint**
  - 設定: @remix-run/eslint-config (React Router推奨)
  - プラグイン: 
    - eslint-plugin-react-hooks
    - @typescript-eslint/eslint-plugin

- **Prettier**
  - 設定: チーム統一のフォーマット
  - 統合: ESLintと連携

### テスト
- **Vitest**
  - 理由: Viteベースで高速、モダンなテストランナー
  - 用途: ユニットテスト、統合テスト

- **React Testing Library**
  - 理由: ユーザー視点のテスト
  - 用途: コンポーネントテスト

- **Playwright**
  - 理由: 信頼性の高いE2Eテスト
  - 用途: エンドツーエンドテスト

---

## ライブラリ一覧

### 必須ライブラリ

```json
{
  "dependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "react-router": "^7.0.0",
    "@microsoft/microsoft-graph-client": "^3.0.7",
    "@azure/msal-node": "^2.14.0",
    "zod": "^3.23.8",
    "winston": "^3.14.0"
  },
  "devDependencies": {
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0",
    "@types/node": "^24.0.0",
    "typescript": "^5.6.0",
    "vite": "^6.0.0",
    "@vitejs/plugin-react": "^4.3.0",
    "tailwindcss": "^3.4.0",
    "eslint": "^9.0.0",
    "prettier": "^3.3.0",
    "vitest": "^2.0.0",
    "@testing-library/react": "^16.0.0",
    "playwright": "^1.47.0"
  }
}
```

### shadcn/uiコンポーネント

```bash
npx shadcn@latest add button
npx shadcn@latest add input
npx shadcn@latest add card
npx shadcn@latest add avatar
npx shadcn@latest add scroll-area
npx shadcn@latest add separator
npx shadcn@latest add alert
npx shadcn@latest add dialog
```

### UI拡張ライブラリ

```bash
# Markdownレンダリング
npm install react-markdown remark-gfm

# コードブロックのシンタックスハイライト
npm install react-syntax-highlighter @types/react-syntax-highlighter
```

---

## アーキテクチャパターン

### サーバーサイドレンダリング（SSR）
- React Router v7のSSR機能を活用
- 初回ロード時のパフォーマンス向上
- SEO対応（将来的）

### ストリーミング
- Dify APIからのストリーミングレスポンス
- Server-Sent Events (SSE)でリアルタイム表示
- チャンク単位での段階的レンダリング

### セッション管理
- **カスタムセッション管理**: Express.jsに依存しない独自実装
  - セッションIDの生成・署名・検証を自前で実装
  - Web標準API（Request/Response）を使用
  - React Router v7との互換性を重視
- **ストレージ**: 現在はメモリストレージ（開発用）
- **将来的にRedisでスケールアウト対応**

---

## セキュリティ考慮事項

### 認証・認可
- OAuth 2.0 / OpenID Connect
- JWTトークンの検証
- セッションタイムアウト（24時間）

### API保護
- Dify API Keyはサーバーサイドのみ
- CORS設定の適切な管理
- レートリミット（30req/分）

### データ保護
- HTTPS通信（本番環境）
- Secure Cookie（HTTPOnly, SameSite）
- セッションシークレットの適切な管理

---

## パフォーマンス最適化

### フロントエンド
- React Compilerによる自動最適化（今後）
- Code Splitting（React Router自動）
- Lazy Loading（重要でないコンポーネント）

### バックエンド
- Dify APIのタイムアウト設定（30秒）
- リトライ機能（最大3回）
- レスポンスキャッシュ（将来的）

---

## モニタリング・ロギング

### ロギング
- **winston**
  - 構造化ログ
  - ファイルローテーション
  - レベル別ログ出力

### メトリクス（将来的）
- **Azure Application Insights**
  - パフォーマンス監視
  - エラートラッキング
  - ユーザー行動分析

---

## 開発環境

### 必須ツール
- Node.js 24 LTS
- npm 11
- Docker Desktop（ローカルテスト用）
- Visual Studio Code（推奨）

### 推奨VS Code拡張
- ESLint
- Prettier
- TypeScript and JavaScript Language Features
- Tailwind CSS IntelliSense
- GitHub Copilot（任意）

---

## 技術選定の理由まとめ

| 技術 | 選定理由 |
|------|----------|
| React 19 | Actions API、Document Metadata、改善されたSuspense |
| Node.js 24 | LTSサポート（~2028年4月）、最新V8エンジン |
| TypeScript | 型安全性、開発者体験の向上 |
| React Router v7 | React 19との統合、SSR、Actions API対応 |
| Tailwind CSS | 高速開発、ユーティリティファースト |
| shadcn/ui | カスタマイズ可能、アクセシビリティ対応 |
| Microsoft Entra ID | 社内システム統合、既存アカウント活用 |
| Dify | プライベート運用、ナレッジベース管理が容易 |
| Azure App Service | Azureエコシステム統合、マネージドサービス |

---

**関連ドキュメント:**
- [環境変数設定](./02_環境変数設定.md)
- [実装ガイド Phase 1](./08_実装ガイド_Phase1.md)

**最終更新**: 2025年11月
