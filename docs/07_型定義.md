# 型定義

このドキュメントでは、プロジェクトで使用するTypeScript型定義を説明します。

---

## セッション関連型

### app/types/session.ts

```typescript
/**
 * ユーザーセッション情報
 */
export interface UserSession {
  /** Entra ID User Object ID */
  userId: string;
  
  /** ユーザーEmail (例: user@company.com) */
  userEmail: string;
  
  /** 表示名 (例: 田中 太郎) */
  displayName: string;
  
  /** 所属コード (例: 001, 002) */
  departmentCode: string;
  
  /** 所属部署名 (例: 営業部) */
  departmentName?: string;
  
  /** Microsoft Graph Access Token */
  accessToken: string;
  
  /** Refresh Token (オプション) */
  refreshToken?: string;
  
  /** トークン有効期限 (Unix timestamp) */
  tokenExpiresAt: number;
  
  /** セッション作成日時 (Unix timestamp) */
  createdAt: number;
  
  /** 最終アクセス日時 (Unix timestamp) */
  lastAccessedAt: number;
}

/**
 * セッションCookie
 */
export interface SessionCookie {
  /** セッションID */
  sessionId: string;
  
  /** 署名 */
  signature: string;
}

/**
 * セッションストレージインターフェース
 */
export interface SessionStorage {
  get(sessionId: string): Promise<UserSession | null>;
  set(sessionId: string, session: UserSession): Promise<void>;
  delete(sessionId: string): Promise<void>;
  exists(sessionId: string): Promise<boolean>;
}
```

---

## チャット関連型

### app/types/chat.ts

```typescript
/**
 * メッセージの役割
 */
export type MessageRole = 'user' | 'assistant' | 'system';

/**
 * チャットメッセージ
 */
export interface Message {
  /** メッセージID */
  id: string;
  
  /** 会話ID */
  conversationId: string;
  
  /** メッセージの役割 */
  role: MessageRole;
  
  /** メッセージ内容 */
  content: string;
  
  /** 作成日時 (Unix timestamp) */
  timestamp: number;
  
  /** ストリーミング中かどうか */
  isStreaming?: boolean;
  
  /** メッセージが完了したかどうか */
  isComplete?: boolean;
  
  /** エラー情報 */
  error?: string;
}

/**
 * チャットセッション
 */
export interface ChatSession {
  /** 会話ID */
  conversationId: string;
  
  /** 会話タイトル */
  title: string;
  
  /** メッセージ一覧 */
  messages: Message[];
  
  /** 作成日時 (Unix timestamp) */
  createdAt: number;
  
  /** 更新日時 (Unix timestamp) */
  updatedAt: number;
  
  /** ユーザーID */
  userId: string;
  
  /** 所属コード */
  departmentCode: string;
}

/**
 * チャットログ（分析用）
 */
export interface ChatLog {
  /** ログID */
  logId: string;
  
  /** メッセージID */
  messageId: string;
  
  /** 会話ID */
  conversationId: string;
  
  /** ユーザーID */
  userId: string;
  
  /** ユーザーEmail */
  userEmail: string;
  
  /** 所属コード */
  departmentCode: string;
  
  /** ユーザーの質問 */
  query: string;
  
  /** AIの回答 */
  answer: string;
  
  /** タイムスタンプ (Unix timestamp) */
  timestamp: number;
  
  /** 使用トークン数 */
  tokensUsed?: {
    prompt: number;
    completion: number;
    total: number;
  };
  
  /** レスポンスタイム (ms) */
  responseTime?: number;
  
  /** 検索結果のメタデータ */
  metadata?: {
    retriever_resources?: Array<{
      dataset_name: string;
      document_name: string;
      score: number;
    }>;
  };
}
```

---

## Dify API関連型

### app/types/dify.ts

```typescript
/**
 * Dify API リクエスト（共通部分）
 */
interface DifyRequestBase {
  /** ユーザー情報 */
  inputs: {
    user_id: string;
    department_code: string;
  };
  
  /** ユーザーの質問 */
  query: string;
  
  /** 会話ID（新規の場合は空文字） */
  conversation_id?: string;
  
  /** ユーザー識別子 */
  user: string;
}

/**
 * Dify チャットリクエスト（ブロッキングモード）
 */
export interface DifyChatRequest extends DifyRequestBase {
  response_mode: 'blocking';
}

/**
 * Dify チャットリクエスト（ストリーミングモード）
 */
export interface DifyStreamRequest extends DifyRequestBase {
  response_mode: 'streaming';
}

/**
 * Dify チャットレスポンス（ブロッキングモード）
 */
export interface DifyChatResponse {
  event: 'message';
  message_id: string;
  conversation_id: string;
  mode: 'chat';
  answer: string;
  metadata: {
    usage: {
      prompt_tokens: number;
      prompt_unit_price: string;
      prompt_price_unit: string;
      prompt_price: string;
      completion_tokens: number;
      completion_unit_price: string;
      completion_price_unit: string;
      completion_price: string;
      total_tokens: number;
      total_price: string;
      currency: string;
      latency: number;
    };
    retriever_resources: Array<{
      position: number;
      dataset_id: string;
      dataset_name: string;
      document_id: string;
      document_name: string;
      segment_id: string;
      score: number;
      content: string;
    }>;
  };
  created_at: number;
}

/**
 * Dify SSE イベント（ストリーミングモード）
 */
export type DifyStreamEvent = 
  | DifyMessageStartEvent 
  | DifyMessageChunkEvent 
  | DifyMessageEndEvent 
  | DifyErrorEvent;

/**
 * メッセージ開始イベント
 */
export interface DifyMessageStartEvent {
  event: 'message';
  task_id: string;
  id: string;
  message_id: string;
  conversation_id: string;
  mode: 'chat';
  answer: '';
  created_at: number;
}

/**
 * メッセージチャンクイベント
 */
export interface DifyMessageChunkEvent {
  event: 'message';
  task_id: string;
  id: string;
  message_id: string;
  conversation_id: string;
  mode: 'chat';
  answer: string;
  created_at: number;
}

/**
 * メッセージ終了イベント
 */
export interface DifyMessageEndEvent {
  event: 'message_end';
  task_id: string;
  id: string;
  message_id: string;
  conversation_id: string;
  mode: 'chat';
  metadata: {
    usage: {
      prompt_tokens: number;
      completion_tokens: number;
      total_tokens: number;
      total_price: string;
      currency: string;
      latency: number;
    };
    retriever_resources: Array<any>;
  };
  created_at: number;
}

/**
 * エラーイベント
 */
export interface DifyErrorEvent {
  event: 'error';
  task_id: string;
  message_id: string;
  status: number;
  code: string;
  message: string;
}

/**
 * Dify エラーレスポンス
 */
export interface DifyErrorResponse {
  code: string;
  message: string;
  status: number;
}
```

---

## Microsoft Graph API関連型

### app/types/graph.ts

```typescript
/**
 * Microsoft Graph ユーザー情報
 */
export interface GraphUser {
  /** User Object ID */
  id: string;
  
  /** ユーザープリンシパル名 (例: user@company.com) */
  userPrincipalName: string;
  
  /** 表示名 (例: 田中 太郎) */
  displayName: string;
  
  /** 名 */
  givenName: string;
  
  /** 姓 */
  surname: string;
  
  /** メールアドレス */
  mail: string;
  
  /** 役職 */
  jobTitle?: string;
  
  /** 部署名 */
  department?: string;
  
  /** オフィス所在地 */
  officeLocation?: string;
  
  /** 携帯電話番号 */
  mobilePhone?: string;
  
  /** 業務用電話番号 */
  businessPhones: string[];
}

/**
 * Microsoft Graph グループ情報
 */
export interface GraphGroup {
  '@odata.type': '#microsoft.graph.group';
  
  /** Group Object ID */
  id: string;
  
  /** グループ名 (例: DEPT_001_営業部) */
  displayName: string;
  
  /** グループの説明 */
  description?: string;
  
  /** グループメールアドレス */
  mail?: string;
}

/**
 * グループメンバーシップレスポンス
 */
export interface MemberOfResponse {
  '@odata.context': string;
  value: GraphGroup[];
}

/**
 * 所属部署情報
 */
export interface DepartmentInfo {
  /** 所属コード (例: 001) */
  code: string;
  
  /** 部署名 (例: 営業部) */
  name: string;
  
  /** グループID */
  groupId: string;
  
  /** グループ名 (例: DEPT_001_営業部) */
  groupName: string;
}
```

---

## エラー関連型

### app/types/error.ts

```typescript
/**
 * エラーコード
 */
export enum ErrorCode {
  // 認証エラー (1xxx)
  AUTH_INVALID_TOKEN = 1001,
  AUTH_TOKEN_EXPIRED = 1002,
  AUTH_NO_PERMISSION = 1003,
  AUTH_DEPARTMENT_NOT_FOUND = 1004,
  AUTH_SESSION_EXPIRED = 1005,
  AUTH_INVALID_SESSION = 1006,
  
  // Graph API エラー (1xxx)
  GRAPH_API_ERROR = 1100,
  GRAPH_USER_NOT_FOUND = 1101,
  GRAPH_GROUP_NOT_FOUND = 1102,
  
  // Dify API エラー (2xxx)
  DIFY_CONNECTION_FAILED = 2001,
  DIFY_TIMEOUT = 2002,
  DIFY_INVALID_RESPONSE = 2003,
  DIFY_API_ERROR = 2004,
  DIFY_STREAMING_ERROR = 2005,
  
  // バリデーションエラー (3xxx)
  VALIDATION_EMPTY_MESSAGE = 3001,
  VALIDATION_MESSAGE_TOO_LONG = 3002,
  VALIDATION_INVALID_INPUT = 3003,
  
  // レートリミットエラー (4xxx)
  RATE_LIMIT_EXCEEDED = 4001,
  
  // システムエラー (5xxx)
  INTERNAL_SERVER_ERROR = 5000,
  DATABASE_ERROR = 5001,
  CONFIGURATION_ERROR = 5002,
}

/**
 * アプリケーションエラー
 */
export class AppError extends Error {
  public readonly code: ErrorCode;
  public readonly statusCode: number;
  public readonly isOperational: boolean;
  public readonly timestamp: number;
  
  constructor(
    code: ErrorCode,
    message: string,
    statusCode: number = 500,
    isOperational: boolean = true
  ) {
    super(message);
    
    this.name = 'AppError';
    this.code = code;
    this.statusCode = statusCode;
    this.isOperational = isOperational;
    this.timestamp = Date.now();
    
    // Stackトレースを正しく保持
    Error.captureStackTrace(this, this.constructor);
  }
}

/**
 * エラーレスポンス
 */
export interface ErrorResponse {
  error: {
    code: ErrorCode;
    message: string;
    details?: any;
  };
  timestamp: number;
}
```

---

## 型安全性のベストプラクティス

### 1. 型ガード

```typescript
// app/lib/utils/type-guards.ts

export function isDifyErrorResponse(obj: any): obj is DifyErrorResponse {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'code' in obj &&
    'message' in obj &&
    'status' in obj
  );
}

export function isUserSession(obj: any): obj is UserSession {
  return (
    typeof obj === 'object' &&
    obj !== null &&
    'userId' in obj &&
    'userEmail' in obj &&
    'departmentCode' in obj
  );
}
```

### 2. ユーティリティ型

```typescript
// app/types/utils.ts

/**
 * オブジェクトから特定のプロパティを必須にする
 */
export type RequireField<T, K extends keyof T> = T & Required<Pick<T, K>>;

/**
 * オブジェクトから特定のプロパティを除外する
 */
export type OmitStrict<T, K extends keyof T> = Pick<T, Exclude<keyof T, K>>;

/**
 * APIレスポンスのラッパー型
 */
export interface ApiResponse<T> {
  data?: T;
  error?: ErrorResponse;
  success: boolean;
}
```

### 3. 型の再利用

```typescript
// app/types/index.ts

// すべての型をエクスポート
export * from './session';
export * from './chat';
export * from './dify';
export * from './graph';
export * from './error';
export * from './utils';
export type { Env } from '../lib/utils/env';
```

---

**関連ドキュメント:**
- [API仕様](./03_API仕様.md)
- [セッション管理](./05_セッション管理.md)
- [エラーハンドリング](./06_エラーハンドリング.md)

**最終更新**: 2025年11月
