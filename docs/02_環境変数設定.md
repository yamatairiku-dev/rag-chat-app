# 環境変数設定

このドキュメントでは、プロジェクトで使用する環境変数とそのバリデーションについて説明します。

---

## .env.example

プロジェクトルートに以下の `.env.example` を配置してください。

```bash
# ================================
# Azure App Service設定
# ================================
NODE_ENV=production
PORT=8080

# ================================
# Microsoft Entra ID (旧 Azure AD)
# ================================
ENTRA_CLIENT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ENTRA_CLIENT_SECRET=your-client-secret-here
ENTRA_TENANT_ID=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
ENTRA_REDIRECT_URI=https://your-app.azurewebsites.net/callback
ENTRA_POST_LOGOUT_REDIRECT_URI=https://your-app.azurewebsites.net
ENTRA_AUTHORITY=https://login.microsoftonline.com

# ================================
# Microsoft Graph API
# ================================
GRAPH_API_URL=https://graph.microsoft.com/v1.0
GRAPH_API_SCOPE=https://graph.microsoft.com/.default
# 所属コードを含むグループ名のプレフィックス
# 例: グループ名が "DEPT_001_営業部" の場合、001が所属コード
GRAPH_DEPARTMENT_GROUP_PREFIX=DEPT_

# ================================
# Dify API
# ================================
DIFY_API_URL=https://your-dify-vm.japaneast.cloudapp.azure.com
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
DIFY_TIMEOUT=30000  # タイムアウト(ms)
DIFY_MAX_RETRIES=3  # リトライ回数

# ================================
# セッション管理
# ================================
SESSION_SECRET=your-session-secret-minimum-32-characters-long
SESSION_MAX_AGE=86400000  # 24時間(ms)
SESSION_RESET_HOUR=0  # 0時にセッションリセット
SESSION_STORAGE=memory  # memory | redis (将来的にRedis対応)

# ================================
# Cookie設定
# ================================
COOKIE_DOMAIN=.your-domain.com
COOKIE_SECURE=true
COOKIE_SAME_SITE=lax
COOKIE_HTTP_ONLY=true

# ================================
# ログ設定
# ================================
LOG_LEVEL=info  # debug, info, warn, error
LOG_DIRECTORY=./logs
LOG_MAX_FILES=30  # ログファイル保持日数

# ================================
# パフォーマンス設定
# ================================
MAX_MESSAGE_LENGTH=2000  # メッセージ最大文字数
RATE_LIMIT_WINDOW_MS=60000  # レートリミット時間窓(1分)
RATE_LIMIT_MAX_REQUESTS=30  # 1分あたり最大リクエスト数
```

---

## 環境変数の説明

### Azure App Service設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `NODE_ENV` | ✅ | - | 実行環境 (`development`, `production`, `test`) |
| `PORT` | ✅ | - | アプリケーションのポート番号 (1-65535) |

### Microsoft Entra ID設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `ENTRA_CLIENT_ID` | ✅ | - | Entra IDアプリのクライアントID (UUID形式) |
| `ENTRA_CLIENT_SECRET` | ✅ | - | Entra IDアプリのクライアントシークレット |
| `ENTRA_TENANT_ID` | ✅ | - | AzureテナントID (UUID形式) |
| `ENTRA_REDIRECT_URI` | ✅ | - | OAuth認証後のリダイレクトURI |
| `ENTRA_POST_LOGOUT_REDIRECT_URI` | ✅ | - | ログアウト後のリダイレクトURI |
| `ENTRA_AUTHORITY` | ❌ | `https://login.microsoftonline.com` | 認証エンドポイント |

### Microsoft Graph API設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `GRAPH_API_URL` | ❌ | `https://graph.microsoft.com/v1.0` | Graph APIのベースURL |
| `GRAPH_API_SCOPE` | ❌ | `https://graph.microsoft.com/.default` | APIスコープ |
| `GRAPH_DEPARTMENT_GROUP_PREFIX` | ❌ | `DEPT_` | 所属コードを含むグループ名のプレフィックス |

**所属コードの取得例:**
- グループ名: `DEPT_001_営業部`
- プレフィックス: `DEPT_`
- 抽出される所属コード: `001`

### Dify API設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `DIFY_API_URL` | ✅ | - | Dify APIのベースURL |
| `DIFY_API_KEY` | ✅ | - | Dify APIキー (`app-`で始まる) |
| `DIFY_TIMEOUT` | ❌ | `30000` | APIタイムアウト（ミリ秒） |
| `DIFY_MAX_RETRIES` | ❌ | `3` | APIリトライ回数 (0-10) |

### セッション管理設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `SESSION_SECRET` | ✅ | - | セッション暗号化キー（最低32文字） |
| `SESSION_MAX_AGE` | ❌ | `86400000` | セッション有効期限（ミリ秒、デフォルト24時間） |
| `SESSION_RESET_HOUR` | ❌ | `0` | セッションリセット時刻 (0-23) |
| `SESSION_STORAGE` | ❌ | `memory` | セッションストレージ (`memory` | `redis`) |

### Cookie設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `COOKIE_DOMAIN` | ❌ | - | Cookieのドメイン |
| `COOKIE_SECURE` | ❌ | `true` | HTTPS通信時のみCookie送信 |
| `COOKIE_SAME_SITE` | ❌ | `lax` | CSRF対策 (`strict` | `lax` | `none`) |
| `COOKIE_HTTP_ONLY` | ❌ | `true` | JavaScriptからのアクセス禁止 |

### ログ設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `LOG_LEVEL` | ❌ | `info` | ログレベル (`debug` | `info` | `warn` | `error`) |
| `LOG_DIRECTORY` | ❌ | `./logs` | ログファイル出力ディレクトリ |
| `LOG_MAX_FILES` | ❌ | `30` | ログファイル保持日数 |

### パフォーマンス設定

| 変数名 | 必須 | デフォルト | 説明 |
|--------|------|-----------|------|
| `MAX_MESSAGE_LENGTH` | ❌ | `2000` | チャットメッセージ最大文字数 |
| `RATE_LIMIT_WINDOW_MS` | ❌ | `60000` | レートリミット時間窓（ミリ秒） |
| `RATE_LIMIT_MAX_REQUESTS` | ❌ | `30` | 時間窓内の最大リクエスト数 |

---

## 環境変数バリデーション

`app/lib/utils/env.ts` に以下のコードを実装してください。

```typescript
// app/lib/utils/env.ts
import { z } from 'zod';

const envSchema = z.object({
  // App
  NODE_ENV: z.enum(['development', 'production', 'test']),
  PORT: z.string().transform(Number).pipe(z.number().min(1).max(65535)),

  // Entra ID
  ENTRA_CLIENT_ID: z.string().uuid('Invalid Entra Client ID format'),
  ENTRA_CLIENT_SECRET: z.string().min(1, 'Entra Client Secret is required'),
  ENTRA_TENANT_ID: z.string().uuid('Invalid Entra Tenant ID format'),
  ENTRA_REDIRECT_URI: z.string().url('Invalid Redirect URI'),
  ENTRA_POST_LOGOUT_REDIRECT_URI: z.string().url('Invalid Post Logout Redirect URI'),
  ENTRA_AUTHORITY: z.string().url().default('https://login.microsoftonline.com'),

  // Graph API
  GRAPH_API_URL: z.string().url().default('https://graph.microsoft.com/v1.0'),
  GRAPH_API_SCOPE: z.string().default('https://graph.microsoft.com/.default'),
  GRAPH_DEPARTMENT_GROUP_PREFIX: z.string().default('DEPT_'),

  // Dify
  DIFY_API_URL: z.string().url('Invalid Dify API URL'),
  DIFY_API_KEY: z.string().startsWith('app-', 'Dify API Key must start with "app-"'),
  DIFY_TIMEOUT: z.string().transform(Number).pipe(z.number().positive()).default('30000'),
  DIFY_MAX_RETRIES: z.string().transform(Number).pipe(z.number().min(0).max(10)).default('3'),

  // Session
  SESSION_SECRET: z.string().min(32, 'Session secret must be at least 32 characters'),
  SESSION_MAX_AGE: z.string().transform(Number).pipe(z.number().positive()).default('86400000'),
  SESSION_RESET_HOUR: z.string().transform(Number).pipe(z.number().min(0).max(23)).default('0'),
  SESSION_STORAGE: z.enum(['memory', 'redis']).default('memory'),

  // Cookie
  COOKIE_DOMAIN: z.string().optional(),
  COOKIE_SECURE: z.string().transform(val => val === 'true').default('true'),
  COOKIE_SAME_SITE: z.enum(['strict', 'lax', 'none']).default('lax'),
  COOKIE_HTTP_ONLY: z.string().transform(val => val === 'true').default('true'),

  // Logging
  LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info'),
  LOG_DIRECTORY: z.string().default('./logs'),
  LOG_MAX_FILES: z.string().transform(Number).pipe(z.number().positive()).default('30'),

  // Performance
  MAX_MESSAGE_LENGTH: z.string().transform(Number).pipe(z.number().positive()).default('2000'),
  RATE_LIMIT_WINDOW_MS: z.string().transform(Number).pipe(z.number().positive()).default('60000'),
  RATE_LIMIT_MAX_REQUESTS: z.string().transform(Number).pipe(z.number().positive()).default('30'),
});

export type Env = z.infer<typeof envSchema>;

// 環境変数をバリデーションして取得
export function validateEnv(): Env {
  try {
    return envSchema.parse(process.env);
  } catch (error) {
    if (error instanceof z.ZodError) {
      const missingVars = error.errors.map(err => `  - ${err.path.join('.')}: ${err.message}`);
      throw new Error(`環境変数の検証に失敗しました:\n${missingVars.join('\n')}`);
    }
    throw error;
  }
}

export const env = validateEnv();
```

---

## 使用例

### アプリケーション起動時

```typescript
// server.ts
import { env } from './app/lib/utils/env';

console.log(`Starting server on port ${env.PORT}`);
console.log(`Environment: ${env.NODE_ENV}`);
```

### 環境変数アクセス

```typescript
// app/lib/auth/entra-client.ts
import { env } from '~/lib/utils/env';

const msalConfig = {
  auth: {
    clientId: env.ENTRA_CLIENT_ID,
    authority: `${env.ENTRA_AUTHORITY}/${env.ENTRA_TENANT_ID}`,
    clientSecret: env.ENTRA_CLIENT_SECRET,
  },
};
```

---

## セットアップ手順

### 1. 環境変数ファイルの作成

```bash
# プロジェクトルートで実行
cp .env.example .env
```

### 2. 必須変数の設定

以下の変数を実際の値に置き換えてください：

```bash
# Microsoft Entra ID設定
ENTRA_CLIENT_ID=<Azure Portalから取得>
ENTRA_CLIENT_SECRET=<Azure Portalで生成>
ENTRA_TENANT_ID=<Azure Portalから取得>
ENTRA_REDIRECT_URI=https://localhost:3000/callback  # 開発環境の場合
ENTRA_POST_LOGOUT_REDIRECT_URI=https://localhost:3000

# Dify API設定
DIFY_API_URL=https://your-dify-vm.japaneast.cloudapp.azure.com
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# セッション管理
SESSION_SECRET=<32文字以上のランダムな文字列>
```

### 3. セッションシークレットの生成

```bash
# Node.jsで生成
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"

# またはOpenSSLで生成
openssl rand -hex 32
```

### 4. 環境変数の検証

```bash
# アプリケーション起動時に自動検証
npm run dev

# 手動検証
node -e "require('./app/lib/utils/env').validateEnv()"
```

---

## 環境別設定

### 開発環境 (.env.development)

```bash
NODE_ENV=development
PORT=3000
ENTRA_REDIRECT_URI=https://localhost:3000/callback
COOKIE_SECURE=false  # 開発環境ではHTTPを許可
LOG_LEVEL=debug
```

### 本番環境 (.env.production)

```bash
NODE_ENV=production
PORT=8080
ENTRA_REDIRECT_URI=https://your-app.azurewebsites.net/callback
COOKIE_SECURE=true
LOG_LEVEL=info
```

---

## トラブルシューティング

### エラー: "Invalid Entra Client ID format"

**原因**: `ENTRA_CLIENT_ID` がUUID形式ではない

**解決策**: Azure Portalでアプリ登録のClient IDを確認し、正しい形式で設定

```bash
# 正しい形式
ENTRA_CLIENT_ID=12345678-1234-1234-1234-123456789012

# 誤った形式
ENTRA_CLIENT_ID=12345678
```

### エラー: "Session secret must be at least 32 characters"

**原因**: `SESSION_SECRET` が32文字未満

**解決策**: 32文字以上の文字列を生成して設定

```bash
# セッションシークレット生成
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### エラー: "Dify API Key must start with 'app-'"

**原因**: `DIFY_API_KEY` が正しい形式ではない

**解決策**: Difyの管理画面からAPI Keyを取得し、`app-`で始まることを確認

---

## セキュリティ考慮事項

### .envファイルの保護

```bash
# .gitignoreに追加（必須）
.env
.env.local
.env.*.local
```

### 本番環境での設定

- Azure App Serviceの「構成」→「アプリケーション設定」で環境変数を設定
- GitHub Secretsに環境変数を保存（CI/CD用）
- 絶対に`.env`ファイルをリポジトリにコミットしない

---

**関連ドキュメント:**
- [技術スタック](./01_技術スタック.md)
- [認証設計](./04_認証設計.md)
- [実装ガイド Phase 1](./08_実装ガイド_Phase1.md)

**最終更新**: 2025年11月
