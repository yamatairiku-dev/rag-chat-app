# 環境変数セットアップガイド

このドキュメントでは、`.env`ファイルの作成方法を説明します。

---

## 📁 ファイル構成

プロジェクトには以下の環境変数ファイルが含まれています：

```
プロジェクトルート/
├── .env.example               # 本番環境用テンプレート
├── .env.development.example   # 開発環境用テンプレート
└── .env                       # 実際の環境変数（作成が必要）
```

---

## 🚀 クイックスタート

### 開発環境の場合

```bash
# 開発環境用テンプレートをコピー
cp .env.development.example .env

# エディタで開いて編集
code .env
# または
vim .env
```

### 本番環境の場合

```bash
# 本番環境用テンプレートをコピー
cp .env.example .env

# エディタで開いて編集
code .env
```

---

## ✏️ 設定手順

### 1. Microsoft Entra ID設定

Azure Portalでアプリ登録を行い、以下の情報を取得してください。

詳細手順は **[docs/04_認証設計.md](./docs/04_認証設計.md)** を参照。

```bash
# 1. Azure Portal (https://portal.azure.com) にアクセス
# 2. Azure Active Directory → アプリの登録 → 新規登録
# 3. 以下の情報を取得:

ENTRA_CLIENT_ID=<アプリケーション(クライアント)ID>
ENTRA_CLIENT_SECRET=<証明書とシークレットで生成>
ENTRA_TENANT_ID=<ディレクトリ(テナント)ID>
```

**開発環境のリダイレクトURI:**
```bash
ENTRA_REDIRECT_URI=http://localhost:3000/auth
ENTRA_POST_LOGOUT_REDIRECT_URI=http://localhost:3000
```

**本番環境のリダイレクトURI:**
```bash
ENTRA_REDIRECT_URI=https://your-app.azurewebsites.net/auth
ENTRA_POST_LOGOUT_REDIRECT_URI=https://your-app.azurewebsites.net
```

### 2. Dify API設定

Dify管理画面からAPI KeyとURLを取得してください。

```bash
# 開発環境（ローカルDify）
DIFY_API_URL=http://localhost:8000/v1

# または開発用VM
DIFY_API_URL=https://dev-dify-vm.japaneast.cloudapp.azure.com/v1

# 本番環境
DIFY_API_URL=https://prod-dify-vm.japaneast.cloudapp.azure.com/v1

# API Key（Dify管理画面から取得）
DIFY_API_KEY=app-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 3. セッションシークレット生成

32文字以上のランダムな文字列を生成してください。

**Node.jsで生成:**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

**OpenSSLで生成:**
```bash
openssl rand -hex 32
```

**生成された文字列を.envに設定:**
```bash
SESSION_SECRET=<生成された64文字の16進数文字列>
```

⚠️ **重要**: 本番環境と開発環境で異なる値を使用してください。

### 4. グループプレフィックス設定

所属コードを含むグループ名のプレフィックスを設定します。

**例: グループ名が "DEPT_001_営業部" の場合**
```bash
GRAPH_DEPARTMENT_GROUP_PREFIX=DEPT_
```

この設定により、"001"が所属コードとして抽出されます。

---

## 📋 環境別設定一覧

### 開発環境の設定

| 変数 | 開発環境の値 | 備考 |
|------|------------|------|
| `NODE_ENV` | `development` | 開発モード |
| `PORT` | `3000` | ローカルポート |
| `ENTRA_REDIRECT_URI` | `http://localhost:3000/auth` | HTTP許可 |
| `DIFY_API_URL` | `http://localhost:8000/v1` | ローカルDify |
| `COOKIE_SECURE` | `false` | HTTPでCookie送信 |
| `LOG_LEVEL` | `debug` | 詳細ログ |

### 本番環境の設定

| 変数 | 本番環境の値 | 備考 |
|------|------------|------|
| `NODE_ENV` | `production` | 本番モード |
| `PORT` | `8080` | App Serviceポート |
| `ENTRA_REDIRECT_URI` | `https://your-app.azurewebsites.net/auth` | HTTPS必須 |
| `DIFY_API_URL` | `https://prod-dify-vm.japaneast.cloudapp.azure.com/v1` | 本番Dify |
| `COOKIE_SECURE` | `true` | HTTPSのみ |
| `LOG_LEVEL` | `info` | 通常ログ |

---

## ✅ 設定チェックリスト

### Azure設定
- [ ] Entra IDアプリを登録した
- [ ] クライアントIDを取得した
- [ ] クライアントシークレットを生成した
- [ ] テナントIDを取得した
- [ ] リダイレクトURIを設定した（Azure Portal側）
- [ ] APIパーミッション (User.Read, GroupMember.Read.All) を追加した
- [ ] 管理者の同意を付与した

### Dify設定
- [ ] DifyのVMまたはローカル環境が起動している
- [ ] Dify管理画面にアクセスできる
- [ ] API Keyを生成した
- [ ] API URLが正しい

### .env設定
- [ ] `.env`ファイルを作成した
- [ ] 必須項目をすべて入力した
- [ ] セッションシークレットを生成した（32文字以上）
- [ ] リダイレクトURIが環境に合っている
- [ ] Cookie設定が環境に合っている

---

## 🔧 検証方法

### 環境変数の検証

プロジェクトには環境変数のバリデーションが組み込まれています。

```bash
# 開発サーバーを起動して確認
npm run dev

# エラーが出た場合、メッセージを確認
# 例: "環境変数の検証に失敗しました: ENTRA_CLIENT_ID: Invalid Entra Client ID format"
```

### 手動検証スクリプト

```bash
# Node.jsで手動検証
node -e "
require('dotenv').config();
const required = [
  'ENTRA_CLIENT_ID',
  'ENTRA_CLIENT_SECRET',
  'ENTRA_TENANT_ID',
  'DIFY_API_URL',
  'DIFY_API_KEY',
  'SESSION_SECRET'
];
const missing = required.filter(key => !process.env[key]);
if (missing.length > 0) {
  console.log('❌ 不足している環境変数:', missing.join(', '));
} else {
  console.log('✅ 必須環境変数はすべて設定されています');
}
"
```

---

## 🔒 セキュリティ注意事項

### ⚠️ 絶対にやってはいけないこと

1. **`.env`ファイルをGitにコミットしない**
   ```bash
   # .gitignoreに必ず含める
   .env
   .env.local
   .env.*.local
   ```

2. **本番環境のシークレットを開発環境で使わない**

3. **シークレットをコードに直接書かない**

4. **`.env`ファイルを他人と共有しない**

### ✅ 推奨事項

1. **環境別にシークレットを分ける**
   - 開発: 開発用のシークレット
   - ステージング: ステージング用のシークレット
   - 本番: 本番用のシークレット

2. **定期的にシークレットをローテーション**
   - クライアントシークレット: 3-6ヶ月ごと
   - セッションシークレット: 必要に応じて

3. **Azure App Serviceでは環境変数を使用**
   ```bash
   # ローカルの.envファイルを使わず
   # Azure Portal → App Service → 構成 → アプリケーション設定
   ```

---

## 🆘 トラブルシューティング

### エラー: "Invalid Entra Client ID format"

**原因**: `ENTRA_CLIENT_ID`がUUID形式ではない

**解決策**: Azure Portalで正しいクライアントIDをコピー
```bash
# 正しい形式
ENTRA_CLIENT_ID=12345678-1234-1234-1234-123456789012

# 誤った形式
ENTRA_CLIENT_ID=12345678
```

### エラー: "Session secret must be at least 32 characters"

**原因**: `SESSION_SECRET`が短すぎる

**解決策**: 新しいシークレットを生成
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### エラー: "Invalid Dify API URL"

**原因**: `DIFY_API_URL`が正しくない

**解決策**: URL形式を確認
```bash
# 正しい形式
DIFY_API_URL=https://your-dify-vm.japaneast.cloudapp.azure.com/v1
DIFY_API_URL=http://localhost:8000/v1

# 誤った形式
DIFY_API_URL=your-dify-vm  # http:// or https:// が必要
DIFY_API_URL=http://localhost:8000  # /v1 が必要
```

### 認証が失敗する

**チェック項目:**
1. Azure Portalのリダイレクトuriと.envのURIが一致しているか
2. APIパーミッションが付与されているか
3. 管理者の同意が付与されているか

---

## 📚 関連ドキュメント

- **[docs/02_環境変数設定.md](./docs/02_環境変数設定.md)** - 環境変数の詳細説明
- **[docs/04_認証設計.md](./docs/04_認証設計.md)** - Azure Portal設定手順
- **[docs/12_チェックリスト.md](./docs/12_チェックリスト.md)** - 実装チェックリスト

---

**最終更新**: 2025年11月
