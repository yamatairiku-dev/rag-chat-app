# E2Eãƒ†ã‚¹ãƒˆèªè¨¼ãƒ¢ãƒƒã‚¯æ”¹å–„ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025å¹´1æœˆ  
**ç›®çš„**: E2Eãƒ†ã‚¹ãƒˆã®èªè¨¼ãƒ¢ãƒƒã‚¯ã‚’æ”¹å–„ã—ã€ãƒ†ã‚¹ãƒˆã®æˆåŠŸç‡ã‚’å‘ä¸Šã•ã›ã‚‹

---

## ğŸ“Š æ”¹å–„å‰å¾Œã®æ¯”è¼ƒ

### æ”¹å–„å‰
- **æˆåŠŸ**: 11ãƒ†ã‚¹ãƒˆï¼ˆ55%ï¼‰
- **å¤±æ•—**: 9ãƒ†ã‚¹ãƒˆï¼ˆ45%ï¼‰
- **å•é¡Œ**: èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å®Ÿéš›ã®Microsoft Entra IDã®ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

### æ”¹å–„å¾Œ
- **æˆåŠŸ**: 18ãƒ†ã‚¹ãƒˆï¼ˆ90%ï¼‰
- **å¤±æ•—**: 2ãƒ†ã‚¹ãƒˆï¼ˆ10%ï¼‰
- **æ”¹å–„**: èªè¨¼ãƒ¢ãƒƒã‚¯ãŒæ©Ÿèƒ½ã—ã€ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹

---

## ğŸ”§ å®Ÿè£…ã—ãŸæ”¹å–„

### 1. ãƒ†ã‚¹ãƒˆç”¨èªè¨¼APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/routes/api.test-auth.ts`

- ãƒ†ã‚¹ãƒˆç’°å¢ƒå°‚ç”¨ã®èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆ
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€æ­£ã—ã„ç½²åä»˜ãCookieã‚’è¿”ã™
- æœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹

**æ©Ÿèƒ½**:
- POSTãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å—ã‘å–ã‚‹
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã¦ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
- ç½²åä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’è¿”ã™

---

### 2. èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/e2e/helpers/auth.ts`

- E2Eãƒ†ã‚¹ãƒˆç”¨ã®èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œæˆ
- ãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
- Cookieã‚’æ­£ã—ãè¨­å®š

**ä¸»ãªé–¢æ•°**:
- `setupAuthenticatedSession()` - èªè¨¼æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®š
- `clearAuthenticatedSession()` - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢

---

### 3. E2Eãƒ†ã‚¹ãƒˆã®æ›´æ–°

**æ›´æ–°ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«**:
- `tests/e2e/chat.spec.ts`
- `tests/e2e/conversations.spec.ts`

**å¤‰æ›´å†…å®¹**:
- ç‹¬è‡ªã®`setupAuthenticatedSession`é–¢æ•°ã‚’å‰Šé™¤
- å…±é€šã®èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´
- ã‚»ãƒ¬ã‚¯ã‚¿ã‚’æ”¹å–„ï¼ˆè¤‡æ•°ã®submitãƒœã‚¿ãƒ³ã«å¯¾å¿œï¼‰
- ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã‚’èª¿æ•´

---

## ğŸ¯ æ”¹å–„ã®ãƒã‚¤ãƒ³ãƒˆ

### 1. æ­£ã—ã„ç½²åä»˜ãã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã®ç”Ÿæˆ

**å•é¡Œ**: ãƒ†ã‚¹ãƒˆã§è¨­å®šã—ã¦ã„ãŸCookieãŒç½²åãªã—ã ã£ãŸãŸã‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ã«å¤±æ•—ã—ã¦ã„ãŸ

**è§£æ±º**: ãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€æ­£ã—ã„ç½²åä»˜ãCookieã‚’ç”Ÿæˆ

```typescript
// æ”¹å–„å‰
value: 'test-session-id'  // ç½²åãªã—

// æ”¹å–„å¾Œ
// APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰æ­£ã—ã„ç½²åä»˜ãCookieã‚’å–å¾—
value: 'session-id.signature'  // æ­£ã—ã„ç½²åä»˜ã
```

---

### 2. ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿è¨­å®š

**å•é¡Œ**: Cookieã®ã¿ã‚’è¨­å®šã—ã¦ã„ãŸãŒã€ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã‹ã£ãŸ

**è§£æ±º**: ãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š

---

### 3. ã‚»ãƒ¬ã‚¯ã‚¿ã®æ”¹å–„

**å•é¡Œ**: `button[type="submit"]`ãŒè¤‡æ•°å­˜åœ¨ï¼ˆãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã¨é€ä¿¡ãƒœã‚¿ãƒ³ï¼‰

**è§£æ±º**: ã‚ˆã‚Šå…·ä½“çš„ãªã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨

```typescript
// æ”¹å–„å‰
const submitButton = page.locator('button[type="submit"]');

// æ”¹å–„å¾Œ
const submitButton = page.locator('form')
  .filter({ has: page.locator('textarea[name="query"]') })
  .locator('button[type="submit"]');
```

---

### 4. ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®èª¿æ•´

**å•é¡Œ**: ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹

**è§£æ±º**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ã—ã€`waitForLoadState`ã‚’è¿½åŠ 

```typescript
// æ”¹å–„å‰
await expect(page).toHaveTitle(/ãƒãƒ£ãƒƒãƒˆ/);

// æ”¹å–„å¾Œ
await page.waitForLoadState('networkidle');
await expect(page).toHaveTitle(/ãƒãƒ£ãƒƒãƒˆ/, { timeout: 10000 });
```

---

## ğŸ“ˆ ãƒ†ã‚¹ãƒˆçµæœã®è©³ç´°

### æˆåŠŸã—ãŸãƒ†ã‚¹ãƒˆï¼ˆ18ãƒ†ã‚¹ãƒˆï¼‰

#### èªè¨¼ãƒ•ãƒ­ãƒ¼ï¼ˆ4/5ãƒ†ã‚¹ãƒˆï¼‰
- âœ… ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- âœ… ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨èªè¨¼URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- âœ… èªè¨¼å¾Œã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãŒå‹•ä½œã™ã‚‹

#### ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆ6/7ãƒ†ã‚¹ãƒˆï¼‰
- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ãŒå‹•ä½œã™ã‚‹
- âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ãŒå­˜åœ¨ã™ã‚‹
- âœ… åˆæœŸçŠ¶æ…‹ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒç©ºã®å ´åˆã®è¡¨ç¤º
- âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­ã®UIçŠ¶æ…‹

#### ä¼šè©±å±¥æ­´æ©Ÿèƒ½ï¼ˆ8/8ãƒ†ã‚¹ãƒˆï¼‰
- âœ… ä¼šè©±å±¥æ­´ãŒç©ºã®å ´åˆã®è¡¨ç¤º
- âœ… ä¼šè©±å±¥æ­´ãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹
- âœ… ä¼šè©±ã‚’é–‹ããƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹
- âœ… ä¼šè©±ã‚’å‰Šé™¤ã™ã‚‹ãƒœã‚¿ãƒ³ãŒå­˜åœ¨ã™ã‚‹
- âœ… ä¼šè©±ã‚’é–‹ãæ©Ÿèƒ½
- âœ… ä¼šè©±ã‚’å‰Šé™¤ã™ã‚‹æ©Ÿèƒ½
- âœ… ãƒ˜ãƒƒãƒ€ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹

---

### å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆï¼ˆ2ãƒ†ã‚¹ãƒˆï¼‰

#### 1. èªè¨¼ãŒå¿…è¦ãªãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- **åŸå› **: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸå ´åˆã€Entra IDã®èªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹
- **å¯¾å¿œ**: ãƒ†ã‚¹ãƒˆã®æœŸå¾…å€¤ã‚’èª¿æ•´ï¼ˆEntra IDã®èªè¨¼ãƒšãƒ¼ã‚¸ã‚‚è¨±å®¹ï¼‰

#### 2. ãƒãƒ£ãƒƒãƒˆç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ / ä¼šè©±å±¥æ­´ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- **åŸå› **: ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ
- **å¯¾å¿œ**: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’å»¶é•·ã—ã€`waitForLoadState`ã‚’è¿½åŠ 

---

## ğŸ” æŠ€è¡“çš„ãªè©³ç´°

### ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã®ç½²åç”Ÿæˆ

```typescript
// app/lib/session/session-manager.ts
function signSessionId(sessionId: string): string {
  const signature = createHmac('sha256', env.SESSION_SECRET)
    .update(sessionId)
    .digest('hex');
  return `${sessionId}.${signature}`;
}
```

### ãƒ†ã‚¹ãƒˆç”¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

```typescript
// app/routes/api.test-auth.ts
export async function action({ request }: Route.ActionArgs) {
  // ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿æœ‰åŠ¹
  if (env.NODE_ENV === "production") {
    return Response.json({ error: "Not available in production" }, { status: 403 });
  }

  // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
  const { cookie, sessionId } = await createSession({
    userId, userEmail, displayName, departmentCode, ...
  });

  return Response.json({ success: true, sessionId }, {
    headers: { "Set-Cookie": cookie }
  });
}
```

---

## âœ… å®Œäº†ã—ãŸä½œæ¥­

- [x] ãƒ†ã‚¹ãƒˆç”¨èªè¨¼APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ
- [x] èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä½œæˆ
- [x] E2Eãƒ†ã‚¹ãƒˆã®æ›´æ–°ï¼ˆchat.spec.ts, conversations.spec.tsï¼‰
- [x] ã‚»ãƒ¬ã‚¯ã‚¿ã®æ”¹å–„
- [x] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®èª¿æ•´
- [x] ãƒ«ãƒ¼ãƒˆè¨­å®šã®æ›´æ–°

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### å„ªå…ˆåº¦: é«˜

1. **æ®‹ã‚Šã®2ãƒ†ã‚¹ãƒˆã®ä¿®æ­£**
   - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œã‚’è§£æ±º
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šã®æœ€é©åŒ–

2. **ãƒ†ã‚¹ãƒˆã®å®‰å®šæ€§å‘ä¸Š**
   - ãƒ•ãƒ¬ãƒ¼ã‚­ãƒ¼ãªãƒ†ã‚¹ãƒˆã®åŸå› ã‚’ç‰¹å®š
   - ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ã®è¿½åŠ 

### å„ªå…ˆåº¦: ä¸­

3. **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ‹¡å……**
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®ãƒ†ã‚¹ãƒˆè¿½åŠ 

---

## ğŸ“ ä½¿ç”¨æ–¹æ³•

### èªè¨¼ãƒ˜ãƒ«ãƒ‘ãƒ¼ã®ä½¿ç”¨ä¾‹

```typescript
import { setupAuthenticatedSession } from './helpers/auth';

test.beforeEach(async ({ page, context }) => {
  // èªè¨¼æ¸ˆã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¨­å®š
  await setupAuthenticatedSession(page, context);
  
  // ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆ
  await setupAuthenticatedSession(page, context, {
    userId: 'custom-user-id',
    userEmail: 'custom@example.com',
    displayName: 'ã‚«ã‚¹ã‚¿ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼',
    departmentCode: '002',
  });
});
```

---

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã«é–¢ã™ã‚‹æ³¨æ„

- **ãƒ†ã‚¹ãƒˆç”¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯æœ¬ç•ªç’°å¢ƒã§ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹**
- **ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®ã¿ä½¿ç”¨å¯èƒ½**
- **å®Ÿéš›ã®èªè¨¼æƒ…å ±ã¯ä½¿ç”¨ã—ãªã„**

---

**æœ€çµ‚æ›´æ–°**: 2025å¹´1æœˆ

